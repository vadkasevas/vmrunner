"use strict";var _interopRequireDefault3 = require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireDefault2 = _interopRequireDefault3(require("@babel/runtime/helpers/interopRequireDefault"));Object.defineProperty(exports, "__esModule", { value: true });exports.wrapInProxy = exports.generateRandomHash = exports.convertResult = exports.functionFromScript = exports.getScript = exports.wrapScope = undefined;var _regenerator = require("@babel/runtime/regenerator");var _regeneratorRuntime = (0, _interopRequireDefault2["default"])(_regenerator)["default"];var _typeof2 = require("@babel/runtime/helpers/typeof");var _typeof = (0, _interopRequireDefault2["default"])(_typeof2)["default"];var _underscore = require("underscore");var _ = (0, _interopRequireDefault2["default"])(_underscore)["default"];

var _md = require("md5");var md5 = (0, _interopRequireDefault2["default"])(_md)["default"];
var _ejson = require("ejson");var EJSON = (0, _interopRequireDefault2["default"])(_ejson)["default"];
var _vm = require("vm");var vm = (0, _interopRequireDefault2["default"])(_vm)["default"];



var _MalibunCache = require("./MalibunCache");var MalibunCache = (0, _interopRequireDefault2["default"])(_MalibunCache)["default"];
var _cachedRegExp = require("./cachedRegExp");var cachedRegExp = (0, _interopRequireDefault2["default"])(_cachedRegExp)["default"];






var _generator = require("@babel/generator");var babelGenerate = (0, _interopRequireDefault2["default"])(_generator)["default"];var esprima = require('esprima');var escodegen = require('escodegen');var fbCache = new MalibunCache();var functionGenerator = new vm.Script("new Function( vm2Options.functionBody );");var scriptCache = new MalibunCache();var re = cachedRegExp(/^([\s\t\n\r]*return[\s\t\n\r]*)?(\{[\s\S]*\})([\s\t\n\r;]?$)/);var babelParser = require("@babel/parser");
var babelCore = require("@babel/core");

function generateRandomHash() {
  return md5(_.random(100000000) + '_' + _.random(100000000) + '_' + Date.now());
}

var functionFromScript = function functionFromScript(expr, vmCtx) {
  vmCtx.vm2Options = vmCtx.vm2Options || {};
  var vm2OptionsHash = vmCtx.vm2Options.hash;
  if (!vm2OptionsHash) {
    vm2OptionsHash = generateRandomHash();
  }
  var key = md5(expr + ':' + vm2OptionsHash);
  if (re.test(expr)) {
    re.lastIndex = 0;
    expr = expr.replace(re, function (m, prefix, body, suffix) {
      if (prefix === undefined)
      prefix = '';
      if (suffix === undefined)
      suffix = '';
      return "".concat(prefix, " new Object(").concat(body, ")").concat(suffix);
    });
  }

  if (!fbCache.has(key)) {
    var tokens = null;
    var parserMode = 'esprima';
    try {
      tokens = esprima.parseScript(expr, { tolerant: true });
    } catch (err1) {
      try {
        tokens = esprima.parseScript("(function anonymous(){ ".concat(expr, " }).apply( this );"), { tolerant: true });
      } catch (err2) {
        try {
          parserMode = 'babel';
          tokens = babelParser.parse(expr, {
            sourceType: "script",
            plugins: [
            ['decorators', { decoratorsBeforeExport: false }]],

            allowReturnOutsideFunction: true });

        } catch (err3) {
          throw err2;
        }
      }
    }
    if (parserMode == 'esprima') {
      var lastIndex = 0;
      _.each(tokens.body, function (statement, index) {
        if (statement.type != 'EmptyStatement') {
          lastIndex = index;
        }
      });
      var lastExpression = tokens.body[lastIndex];
      if (lastExpression) {
        if (['IfStatement', 'ReturnStatement'].indexOf(lastExpression.type) == -1) {
          tokens.body[tokens.body.length - 1] = {
            type: 'ReturnStatement',
            argument: lastExpression };

        }
        var functionBody = escodegen.generate(tokens);
        //console.log(functionBody);
        vmCtx.vm2Options.functionBody = functionBody;
        var f = functionGenerator.runInContext(vmCtx);
        //var f = new Function(functionBody);
        fbCache.set(key, f, 5 * 60 * 1000);
      }
    } else {
      var _lastIndex = 0;
      _.each(tokens.program.body, function (statement, index) {
        if (statement.type != 'EmptyStatement') {
          _lastIndex = index;
        }
      });
      var _lastExpression = tokens.program.body[_lastIndex];
      if (_lastExpression) {
        if (_lastExpression.type !== 'ReturnStatement') {
          throw new Error('Babel парсер ожидает return');
        }
        /*if (['IfStatement', 'ReturnStatement'].indexOf (lastExpression.type) == -1) {
              if(lastExpression.type==='ClassDeclaration')
                  lastExpression.type='ClassExpression';
              tokens.program.body[tokens.program.body.length - 1] = {
                  type: 'ReturnStatement',
                  argument: lastExpression,
              };
          }*/var _babelCore$transformF =

        babelCore.transformFromAstSync(tokens, expr, {
          babelrc: false,
          configFile: false,
          "presets": [["@babel/preset-env", { targets: { node: true, esmodules: false } }]],
          "plugins": [
          "@babel/plugin-transform-runtime",
          ["@babel/plugin-syntax-dynamic-import"],
          ["@babel/plugin-proposal-optional-chaining"],
          ["@babel/plugin-proposal-decorators", { "legacy": true }]
          /*["transform-es2015-modules-commonjs-simple", {
                                                                        "noMangle": true
                                                                    }]*/],

          "sourceMaps": false,
          "retainLines": true }),code = _babelCore$transformF.code,map = _babelCore$transformF.map,ast = _babelCore$transformF.ast;

        //console.log(code);
        vmCtx.vm2Options.functionBody = code;
        var _f = functionGenerator.runInContext(vmCtx);
        //var f = new Function(functionBody);
        fbCache.set(key, _f, 5 * 60 * 1000);
      }
    }
  }
  return fbCache.get(key);
};


/**
    * @returns {Object} scope
    * @returns {Object} scope.vm
    * @returns {Object} scope.original
    * @param {VMRunner} runner
    * */
function wrapScope(scope, runner, vm2Options) {
  var scopeCopy = {}; //Object.assign({},scope);

  _.each(scope, function (instance, key) {
    var wrapped = null;
    if (_.isObject(instance)) {
      wrapped = new Proxy(instance, {
        get: function get(target, property) {
          return target[property];
        },
        set: function set(target, key, value, receiver) {
          //console.log('set key:',key,'value:',value);
        },
        getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
          return Object.getOwnPropertyDescriptor(target, name);
        },
        ownKeys: function ownKeys(target) {
          return Object.getOwnPropertyNames(target);
        },
        defineProperty: function defineProperty(target, name, propertyDescriptor) {

        },
        deleteProperty: function deleteProperty(target, name) {

        },
        preventExtensions: function preventExtensions(target) {

        },
        has: function has(target, name) {
          return name in target;
        } });

    } else {
      wrapped = instance;
    }
    scopeCopy[key] = wrapped;
  });

  scopeCopy.vm2Options = vm2Options;

  var vmContext = vm.createContext(scopeCopy);
  return {
    vm: vmContext,
    original: scopeCopy };

}

function getScript(code) {
  if (!_.isString(code) || !code) {
    return null;
  }
  if (!scriptCache.has(code)) {
    try {
      var script = new vm.Script(code);
      scriptCache.set(code, script, 5 * 60 * 1000);
    } catch (e) {
      return null;
    }
  }
  return scriptCache.get(code);
}

function convertResult(result) {var converted, check;return _regeneratorRuntime.async(function convertResult$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
          converted = result;if (!
          _.isDate(result)) {_context.next = 5;break;}
          converted = new Date(result.getTime());_context.next = 12;break;case 5:if (!(
          result && _.isFunction(result.then))) {_context.next = 11;break;}_context.next = 8;return _regeneratorRuntime.awrap(
          result);case 8:converted = _context.sent;_context.next = 12;break;case 11:
          if (result && _typeof(result) == 'object') {

            check = function check(target, source, key) {
              var val = source[key];
              if (typeof val == 'function') {
                target[key] = val;
              } else if (_.isDate(val)) {
                target[key] = new Date(val);
              } else if (_.isArray(val) || _.isObject(val)) {
                _.each(_.keys(val), function (valKey) {
                  check(target[key], val, valKey);
                });
              }
            };converted = EJSON.clone(result);
            _.each(_.keys(result), function (key) {
              check(converted, result, key);
            });
          }case 12:return _context.abrupt("return",
          converted);case 13:case "end":return _context.stop();}}});}


function wrapInProxy(instance) {
  return new Proxy(instance, {
    get: function get(target, property) {
      return target[property];
    },
    set: function set(target, key, value, receiver) {

    },
    getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
      return Object.getOwnPropertyDescriptor(target, name);
    },
    ownKeys: function ownKeys(target) {
      return Object.getOwnPropertyNames(target);
    },
    defineProperty: function defineProperty(target, name, propertyDescriptor) {

    },
    deleteProperty: function deleteProperty(target, name) {

    },
    preventExtensions: function preventExtensions(target) {

    },
    has: function has(target, name) {
      return name in target;
    } });

}exports.



wrapScope = wrapScope;exports.getScript = getScript;exports.functionFromScript = functionFromScript;exports.convertResult = convertResult;exports.generateRandomHash = generateRandomHash;exports.wrapInProxy = wrapInProxy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJfIiwibWQ1IiwiRUpTT04iLCJ2bSIsIk1hbGlidW5DYWNoZSIsImNhY2hlZFJlZ0V4cCIsImJhYmVsR2VuZXJhdGUiLCJlc3ByaW1hIiwicmVxdWlyZSIsImVzY29kZWdlbiIsImZiQ2FjaGUiLCJmdW5jdGlvbkdlbmVyYXRvciIsIlNjcmlwdCIsInNjcmlwdENhY2hlIiwicmUiLCJiYWJlbFBhcnNlciIsImJhYmVsQ29yZSIsImdlbmVyYXRlUmFuZG9tSGFzaCIsInJhbmRvbSIsIkRhdGUiLCJub3ciLCJmdW5jdGlvbkZyb21TY3JpcHQiLCJleHByIiwidm1DdHgiLCJ2bTJPcHRpb25zIiwidm0yT3B0aW9uc0hhc2giLCJoYXNoIiwia2V5IiwidGVzdCIsImxhc3RJbmRleCIsInJlcGxhY2UiLCJtIiwicHJlZml4IiwiYm9keSIsInN1ZmZpeCIsInVuZGVmaW5lZCIsImhhcyIsInRva2VucyIsInBhcnNlck1vZGUiLCJwYXJzZVNjcmlwdCIsInRvbGVyYW50IiwiZXJyMSIsImVycjIiLCJwYXJzZSIsInNvdXJjZVR5cGUiLCJwbHVnaW5zIiwiZGVjb3JhdG9yc0JlZm9yZUV4cG9ydCIsImFsbG93UmV0dXJuT3V0c2lkZUZ1bmN0aW9uIiwiZXJyMyIsImVhY2giLCJzdGF0ZW1lbnQiLCJpbmRleCIsInR5cGUiLCJsYXN0RXhwcmVzc2lvbiIsImluZGV4T2YiLCJsZW5ndGgiLCJhcmd1bWVudCIsImZ1bmN0aW9uQm9keSIsImdlbmVyYXRlIiwiZiIsInJ1bkluQ29udGV4dCIsInNldCIsInByb2dyYW0iLCJFcnJvciIsInRyYW5zZm9ybUZyb21Bc3RTeW5jIiwiYmFiZWxyYyIsImNvbmZpZ0ZpbGUiLCJ0YXJnZXRzIiwibm9kZSIsImVzbW9kdWxlcyIsImNvZGUiLCJtYXAiLCJhc3QiLCJnZXQiLCJ3cmFwU2NvcGUiLCJzY29wZSIsInJ1bm5lciIsInNjb3BlQ29weSIsImluc3RhbmNlIiwid3JhcHBlZCIsImlzT2JqZWN0IiwiUHJveHkiLCJ0YXJnZXQiLCJwcm9wZXJ0eSIsInZhbHVlIiwicmVjZWl2ZXIiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJuYW1lIiwiT2JqZWN0Iiwib3duS2V5cyIsImdldE93blByb3BlcnR5TmFtZXMiLCJkZWZpbmVQcm9wZXJ0eSIsInByb3BlcnR5RGVzY3JpcHRvciIsImRlbGV0ZVByb3BlcnR5IiwicHJldmVudEV4dGVuc2lvbnMiLCJ2bUNvbnRleHQiLCJjcmVhdGVDb250ZXh0Iiwib3JpZ2luYWwiLCJnZXRTY3JpcHQiLCJpc1N0cmluZyIsInNjcmlwdCIsImUiLCJjb252ZXJ0UmVzdWx0IiwicmVzdWx0IiwiY29udmVydGVkIiwiaXNEYXRlIiwiZ2V0VGltZSIsImlzRnVuY3Rpb24iLCJ0aGVuIiwiY2hlY2siLCJzb3VyY2UiLCJ2YWwiLCJpc0FycmF5Iiwia2V5cyIsInZhbEtleSIsImNsb25lIiwid3JhcEluUHJveHkiXSwibWFwcGluZ3MiOiJpc0JBQUEsd0MsSUFBT0EsQzs7QUFFUCx5QixJQUFPQyxHO0FBQ1AsOEIsSUFBT0MsSztBQUNQLHdCLElBQU9DLEU7Ozs7QUFJUCw4QyxJQUFPQyxZO0FBQ1AsOEMsSUFBT0MsWTs7Ozs7OztBQU9QLDZDLElBQU9DLGEsa0VBVlAsSUFBTUMsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2QixDQUNBLElBQU1DLFNBQVMsR0FBR0QsT0FBTyxDQUFDLFdBQUQsQ0FBekIsQ0FJQSxJQUFNRSxPQUFPLEdBQUcsSUFBSU4sWUFBSixFQUFoQixDQUNBLElBQU1PLGlCQUFpQixHQUFHLElBQUlSLEVBQUUsQ0FBQ1MsTUFBUCw0Q0FBMUIsQ0FDQSxJQUFNQyxXQUFXLEdBQUcsSUFBSVQsWUFBSixFQUFwQixDQUNBLElBQU1VLEVBQUUsR0FBR1QsWUFBWSxDQUFDLDhEQUFELENBQXZCLENBQ0EsSUFBTVUsV0FBVyxHQUFHUCxPQUFPLENBQUMsZUFBRCxDQUEzQjtBQUVBLElBQU1RLFNBQVMsR0FBR1IsT0FBTyxDQUFD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cUI7QUFnQnRCQyxJQUFBQSxjQWhCc0IsMEJBZ0JQWCxNQWhCTyxFQWdCQ0ssSUFoQkQsRUFnQk07O0FBRTNCLEtBbEJxQjtBQW1CdEJPLElBQUFBLGlCQW5Cc0IsNkJBbUJKWixNQW5CSSxFQW1CRzs7QUFFeEIsS0FyQnFCO0FBc0J0QjlDLElBQUFBLEdBdEJzQixlQXNCbEI4QyxNQXRCa0IsRUFzQlZLLElBdEJVLEVBc0JMO0FBQ2IsYUFBT0EsSUFBSSxJQUFJTCxNQUFmO0FBQ0gsS0F4QnFCLEVBQW5CLENBQVA7O0FBMEJILEM7Ozs7QUFJR1IsUyxHQUFBQSxTLFNBQVV3QixTLEdBQUFBLFMsU0FBVTdFLGtCLEdBQUFBLGtCLFNBQW1CaUYsYSxHQUFBQSxhLFNBQWNyRixrQixHQUFBQSxrQixTQUFtQm1HLFcsR0FBQUEsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnO1xuXG5pbXBvcnQgbWQ1IGZyb20gJ21kNSc7XG5pbXBvcnQgRUpTT04gZnJvbSAnZWpzb24nO1xuaW1wb3J0IHZtIGZyb20gJ3ZtJztcblxuY29uc3QgZXNwcmltYSA9IHJlcXVpcmUoJ2VzcHJpbWEnKTtcbmNvbnN0IGVzY29kZWdlbiA9IHJlcXVpcmUoJ2VzY29kZWdlbicpO1xuaW1wb3J0IE1hbGlidW5DYWNoZSBmcm9tIFwiLi9NYWxpYnVuQ2FjaGVcIjtcbmltcG9ydCBjYWNoZWRSZWdFeHAgZnJvbSAnLi9jYWNoZWRSZWdFeHAnO1xuXG5jb25zdCBmYkNhY2hlID0gbmV3IE1hbGlidW5DYWNoZSgpO1xuY29uc3QgZnVuY3Rpb25HZW5lcmF0b3IgPSBuZXcgdm0uU2NyaXB0KCBgbmV3IEZ1bmN0aW9uKCB2bTJPcHRpb25zLmZ1bmN0aW9uQm9keSApO2AgKTtcbmNvbnN0IHNjcmlwdENhY2hlID0gbmV3IE1hbGlidW5DYWNoZSgpO1xuY29uc3QgcmUgPSBjYWNoZWRSZWdFeHAoL14oW1xcc1xcdFxcblxccl0qcmV0dXJuW1xcc1xcdFxcblxccl0qKT8oXFx7W1xcc1xcU10qXFx9KShbXFxzXFx0XFxuXFxyO10/JCkvKTtcbmNvbnN0IGJhYmVsUGFyc2VyID0gcmVxdWlyZShcIkBiYWJlbC9wYXJzZXJcIik7XG5pbXBvcnQgYmFiZWxHZW5lcmF0ZSBmcm9tICdAYmFiZWwvZ2VuZXJhdG9yJztcbmNvbnN0IGJhYmVsQ29yZSA9IHJlcXVpcmUoXCJAYmFiZWwvY29yZVwiKVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUhhc2goKSB7XG4gICAgcmV0dXJuIG1kNShfLnJhbmRvbSgxMDAwMDAwMDApICsgJ18nICsgXy5yYW5kb20oMTAwMDAwMDAwKSArICdfJyArIERhdGUubm93KCkpO1xufVxuXG5jb25zdCBmdW5jdGlvbkZyb21TY3JpcHQgPSBmdW5jdGlvbihleHByLHZtQ3R4KXtcbiAgICB2bUN0eC52bTJPcHRpb25zID0gdm1DdHgudm0yT3B0aW9ucyB8fCB7fTtcbiAgICBsZXQgdm0yT3B0aW9uc0hhc2ggPSB2bUN0eC52bTJPcHRpb25zLmhhc2g7XG4gICAgaWYoIXZtMk9wdGlvbnNIYXNoKXtcbiAgICAgICAgdm0yT3B0aW9uc0hhc2ggPSBnZW5lcmF0ZVJhbmRvbUhhc2goKTtcbiAgICB9XG4gICAgbGV0IGtleSA9IG1kNSggZXhwcisnOicrdm0yT3B0aW9uc0hhc2ggICk7XG4gICAgaWYocmUudGVzdChleHByKSl7XG4gICAgICAgIHJlLmxhc3RJbmRleCA9IDA7XG4gICAgICAgIGV4cHIgPSBleHByLnJlcGxhY2UocmUsKG0scHJlZml4LGJvZHksc3VmZml4KT0+e1xuICAgICAgICAgICAgaWYocHJlZml4PT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgIHByZWZpeCA9ICcnO1xuICAgICAgICAgICAgaWYoc3VmZml4PT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgIHN1ZmZpeCA9ICcnO1xuICAgICAgICAgICAgcmV0dXJuIGAke3ByZWZpeH0gbmV3IE9iamVjdCgke2JvZHl9KSR7c3VmZml4fWA7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmKCFmYkNhY2hlLmhhcyhrZXkpKSB7XG4gICAgICAgIGxldCB0b2tlbnMgPSBudWxsO1xuICAgICAgICBsZXQgcGFyc2VyTW9kZSA9ICdlc3ByaW1hJztcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgdG9rZW5zID0gZXNwcmltYS5wYXJzZVNjcmlwdChleHByLHt0b2xlcmFudDp0cnVlfSk7XG4gICAgICAgIH1jYXRjaCAoZXJyMSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0b2tlbnMgPSBlc3ByaW1hLnBhcnNlU2NyaXB0KGAoZnVuY3Rpb24gYW5vbnltb3VzKCl7ICR7ZXhwcn0gfSkuYXBwbHkoIHRoaXMgKTtgLHt0b2xlcmFudDp0cnVlfSlcbiAgICAgICAgICAgIH1jYXRjaCAoZXJyMikge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnNlck1vZGUgPSAnYmFiZWwnO1xuICAgICAgICAgICAgICAgICAgICB0b2tlbnMgPSBiYWJlbFBhcnNlci5wYXJzZShleHByLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VUeXBlOiBcInNjcmlwdFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGx1Z2luczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsnZGVjb3JhdG9ycycsIHsgZGVjb3JhdG9yc0JlZm9yZUV4cG9ydDogZmFsc2UgfV1cbiAgICAgICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd1JldHVybk91dHNpZGVGdW5jdGlvbjp0cnVlLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9Y2F0Y2ggKGVycjMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyMjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYocGFyc2VyTW9kZT09J2VzcHJpbWEnKSB7XG4gICAgICAgICAgICBsZXQgbGFzdEluZGV4ID0gMDtcbiAgICAgICAgICAgIF8uZWFjaCAodG9rZW5zLmJvZHksIChzdGF0ZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudC50eXBlICE9ICdFbXB0eVN0YXRlbWVudCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFzdEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsZXQgbGFzdEV4cHJlc3Npb24gPSB0b2tlbnMuYm9keVtsYXN0SW5kZXhdO1xuICAgICAgICAgICAgaWYgKGxhc3RFeHByZXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKFsnSWZTdGF0ZW1lbnQnLCAnUmV0dXJuU3RhdGVtZW50J10uaW5kZXhPZiAobGFzdEV4cHJlc3Npb24udHlwZSkgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLmJvZHlbdG9rZW5zLmJvZHkubGVuZ3RoIC0gMV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnUmV0dXJuU3RhdGVtZW50JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50OiBsYXN0RXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGZ1bmN0aW9uQm9keSA9IGVzY29kZWdlbi5nZW5lcmF0ZSAodG9rZW5zKTtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGZ1bmN0aW9uQm9keSk7XG4gICAgICAgICAgICAgICAgdm1DdHgudm0yT3B0aW9ucy5mdW5jdGlvbkJvZHkgPSBmdW5jdGlvbkJvZHk7XG4gICAgICAgICAgICAgICAgbGV0IGYgPSBmdW5jdGlvbkdlbmVyYXRvci5ydW5JbkNvbnRleHQgKHZtQ3R4KTtcbiAgICAgICAgICAgICAgICAvL3ZhciBmID0gbmV3IEZ1bmN0aW9uKGZ1bmN0aW9uQm9keSk7XG4gICAgICAgICAgICAgICAgZmJDYWNoZS5zZXQgKGtleSwgZiwgNSAqIDYwICogMTAwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgbGV0IGxhc3RJbmRleCA9IDA7XG4gICAgICAgICAgICBfLmVhY2ggKHRva2Vucy5wcm9ncmFtLmJvZHksIChzdGF0ZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudC50eXBlICE9ICdFbXB0eVN0YXRlbWVudCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFzdEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsZXQgbGFzdEV4cHJlc3Npb24gPSB0b2tlbnMucHJvZ3JhbS5ib2R5W2xhc3RJbmRleF07XG4gICAgICAgICAgICBpZiAobGFzdEV4cHJlc3Npb24pIHtcbiAgICAgICAgICAgICAgICBpZihsYXN0RXhwcmVzc2lvbi50eXBlIT09J1JldHVyblN0YXRlbWVudCcpe1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhYmVsINC/0LDRgNGB0LXRgCDQvtC20LjQtNCw0LXRgiByZXR1cm4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLyppZiAoWydJZlN0YXRlbWVudCcsICdSZXR1cm5TdGF0ZW1lbnQnXS5pbmRleE9mIChsYXN0RXhwcmVzc2lvbi50eXBlKSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBpZihsYXN0RXhwcmVzc2lvbi50eXBlPT09J0NsYXNzRGVjbGFyYXRpb24nKVxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEV4cHJlc3Npb24udHlwZT0nQ2xhc3NFeHByZXNzaW9uJztcbiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnByb2dyYW0uYm9keVt0b2tlbnMucHJvZ3JhbS5ib2R5Lmxlbmd0aCAtIDFdID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1JldHVyblN0YXRlbWVudCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmd1bWVudDogbGFzdEV4cHJlc3Npb24sXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSovXG5cbiAgICAgICAgICAgICAgICBjb25zdCB7IGNvZGUsIG1hcCwgYXN0IH0gPSBiYWJlbENvcmUudHJhbnNmb3JtRnJvbUFzdFN5bmModG9rZW5zLCBleHByLCB7XG4gICAgICAgICAgICAgICAgICAgIGJhYmVscmM6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBjb25maWdGaWxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgXCJwcmVzZXRzXCI6IFtbXCJAYmFiZWwvcHJlc2V0LWVudlwiLHt0YXJnZXRzOntub2RlOnRydWUsZXNtb2R1bGVzOmZhbHNlfX1dXSxcbiAgICAgICAgICAgICAgICAgICAgXCJwbHVnaW5zXCI6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiQGJhYmVsL3BsdWdpbi10cmFuc2Zvcm0tcnVudGltZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgW1wiQGJhYmVsL3BsdWdpbi1zeW50YXgtZHluYW1pYy1pbXBvcnRcIl0sXG4gICAgICAgICAgICAgICAgICAgICAgICBbXCJAYmFiZWwvcGx1Z2luLXByb3Bvc2FsLW9wdGlvbmFsLWNoYWluaW5nXCJdLFxuICAgICAgICAgICAgICAgICAgICAgICAgW1wiQGJhYmVsL3BsdWdpbi1wcm9wb3NhbC1kZWNvcmF0b3JzXCIsIHtcImxlZ2FjeVwiOiB0cnVlfV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAvKltcInRyYW5zZm9ybS1lczIwMTUtbW9kdWxlcy1jb21tb25qcy1zaW1wbGVcIiwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwibm9NYW5nbGVcIjogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgfV0qL1xuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgICAgICBcInNvdXJjZU1hcHNcIjogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIFwicmV0YWluTGluZXNcIjogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coY29kZSk7XG4gICAgICAgICAgICAgICAgdm1DdHgudm0yT3B0aW9ucy5mdW5jdGlvbkJvZHkgPSBjb2RlO1xuICAgICAgICAgICAgICAgIGxldCBmID0gZnVuY3Rpb25HZW5lcmF0b3IucnVuSW5Db250ZXh0ICh2bUN0eCk7XG4gICAgICAgICAgICAgICAgLy92YXIgZiA9IG5ldyBGdW5jdGlvbihmdW5jdGlvbkJvZHkpO1xuICAgICAgICAgICAgICAgIGZiQ2FjaGUuc2V0IChrZXksIGYsIDUgKiA2MCAqIDEwMDApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYkNhY2hlLmdldChrZXkpO1xufTtcblxuXG4vKipcbiAqIEByZXR1cm5zIHtPYmplY3R9IHNjb3BlXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBzY29wZS52bVxuICogQHJldHVybnMge09iamVjdH0gc2NvcGUub3JpZ2luYWxcbiAqIEBwYXJhbSB7Vk1SdW5uZXJ9IHJ1bm5lclxuICogKi9cbmZ1bmN0aW9uIHdyYXBTY29wZShzY29wZSxydW5uZXIsdm0yT3B0aW9ucyl7XG4gICAgbGV0IHNjb3BlQ29weSA9IHt9Oy8vT2JqZWN0LmFzc2lnbih7fSxzY29wZSk7XG5cbiAgICBfLmVhY2goc2NvcGUsKGluc3RhbmNlLGtleSk9PntcbiAgICAgICAgbGV0IHdyYXBwZWQgPSBudWxsO1xuICAgICAgICBpZihfLmlzT2JqZWN0KGluc3RhbmNlKSApe1xuICAgICAgICAgICAgd3JhcHBlZCA9IG5ldyBQcm94eShpbnN0YW5jZSx7XG4gICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRbcHJvcGVydHldO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcikge1xuICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdzZXQga2V5Oicsa2V5LCd2YWx1ZTonLHZhbHVlKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb3duS2V5cyh0YXJnZXQpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwgbmFtZSwgcHJvcGVydHlEZXNjcmlwdG9yKXtcblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZGVsZXRlUHJvcGVydHkodGFyZ2V0LCBuYW1lKXtcblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcHJldmVudEV4dGVuc2lvbnModGFyZ2V0KXtcblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaGFzKHRhcmdldCwgbmFtZSl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuYW1lIGluIHRhcmdldDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICB3cmFwcGVkID0gaW5zdGFuY2U7XG4gICAgICAgIH1cbiAgICAgICAgc2NvcGVDb3B5W2tleV0gPSB3cmFwcGVkO1xuICAgIH0pO1xuXG4gICAgc2NvcGVDb3B5LnZtMk9wdGlvbnMgPSB2bTJPcHRpb25zO1xuXG4gICAgbGV0IHZtQ29udGV4dCA9IHZtLmNyZWF0ZUNvbnRleHQoIHNjb3BlQ29weSApO1xuICAgIHJldHVybiB7XG4gICAgICAgIHZtOnZtQ29udGV4dCxcbiAgICAgICAgb3JpZ2luYWw6c2NvcGVDb3B5XG4gICAgfVxufVxuXG5mdW5jdGlvbiBnZXRTY3JpcHQoY29kZSl7XG4gICAgaWYoIV8uaXNTdHJpbmcoY29kZSl8fCFjb2RlKXtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmKCFzY3JpcHRDYWNoZS5oYXMoY29kZSkpe1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3Qgc2NyaXB0ID0gbmV3IHZtLlNjcmlwdChjb2RlKTtcbiAgICAgICAgICAgIHNjcmlwdENhY2hlLnNldChjb2RlLCBzY3JpcHQsIDUgKiA2MCAqIDEwMDApO1xuICAgICAgICB9Y2F0Y2goZSl7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2NyaXB0Q2FjaGUuZ2V0KGNvZGUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb252ZXJ0UmVzdWx0KHJlc3VsdCl7XG4gICAgbGV0IGNvbnZlcnRlZCA9IHJlc3VsdDtcbiAgICBpZihfLmlzRGF0ZShyZXN1bHQpKXtcbiAgICAgICAgY29udmVydGVkID0gbmV3IERhdGUoIHJlc3VsdC5nZXRUaW1lKCkgKTtcbiAgICB9ZWxzZSBpZihyZXN1bHQgJiYgXy5pc0Z1bmN0aW9uKHJlc3VsdC50aGVuKSl7XG4gICAgICAgIGNvbnZlcnRlZCA9IGF3YWl0IHJlc3VsdDtcbiAgICB9ZWxzZSBpZihyZXN1bHQmJnR5cGVvZiByZXN1bHQ9PSdvYmplY3QnKXtcbiAgICAgICAgY29udmVydGVkID0gRUpTT04uY2xvbmUocmVzdWx0KTtcbiAgICAgICAgZnVuY3Rpb24gY2hlY2sodGFyZ2V0LHNvdXJjZSxrZXkpe1xuICAgICAgICAgICAgbGV0IHZhbCA9IHNvdXJjZVtrZXldO1xuICAgICAgICAgICAgaWYodHlwZW9mIHZhbD09J2Z1bmN0aW9uJyl7XG4gICAgICAgICAgICAgICAgdGFyZ2V0W2tleV09dmFsO1xuICAgICAgICAgICAgfWVsc2UgaWYoXy5pc0RhdGUodmFsKSl7XG4gICAgICAgICAgICAgICAgdGFyZ2V0W2tleV0gPSBuZXcgRGF0ZSggdmFsICk7XG4gICAgICAgICAgICB9ZWxzZSBpZihfLmlzQXJyYXkodmFsKXx8Xy5pc09iamVjdCh2YWwpKXtcbiAgICAgICAgICAgICAgICBfLmVhY2goXy5rZXlzKHZhbCksKHZhbEtleSk9PntcbiAgICAgICAgICAgICAgICAgICAgY2hlY2soIHRhcmdldFtrZXldICwgdmFsLCB2YWxLZXkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIF8uZWFjaChfLmtleXMocmVzdWx0KSwoa2V5KT0+e1xuICAgICAgICAgICAgY2hlY2soY29udmVydGVkLHJlc3VsdCxrZXkpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcbn1cblxuZnVuY3Rpb24gd3JhcEluUHJveHkoaW5zdGFuY2Upe1xuICAgIHJldHVybiBuZXcgUHJveHkoaW5zdGFuY2Use1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uKHRhcmdldCwgcHJvcGVydHkpIHtcbiAgICAgICAgICAgIHJldHVybiB0YXJnZXRbcHJvcGVydHldO1xuICAgICAgICB9LFxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh0YXJnZXQsIGtleSwgdmFsdWUsIHJlY2VpdmVyKSB7XG5cbiAgICAgICAgfSxcbiAgICAgICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgbmFtZSl7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpO1xuICAgICAgICB9LFxuICAgICAgICBvd25LZXlzKHRhcmdldCl7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModGFyZ2V0KTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBuYW1lLCBwcm9wZXJ0eURlc2NyaXB0b3Ipe1xuXG4gICAgICAgIH0sXG4gICAgICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwgbmFtZSl7XG5cbiAgICAgICAgfSxcbiAgICAgICAgcHJldmVudEV4dGVuc2lvbnModGFyZ2V0KXtcblxuICAgICAgICB9LFxuICAgICAgICBoYXModGFyZ2V0LCBuYW1lKXtcbiAgICAgICAgICAgIHJldHVybiBuYW1lIGluIHRhcmdldDtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5cbmV4cG9ydCB7XG4gICAgd3JhcFNjb3BlLGdldFNjcmlwdCxmdW5jdGlvbkZyb21TY3JpcHQsY29udmVydFJlc3VsdCxnZW5lcmF0ZVJhbmRvbUhhc2gsd3JhcEluUHJveHlcbn1cblxuIl19