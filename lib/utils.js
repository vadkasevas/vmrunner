"use strict";var _interopRequireDefault3 = require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireDefault2 = _interopRequireDefault3(require("@babel/runtime/helpers/interopRequireDefault"));Object.defineProperty(exports, "__esModule", { value: true });exports.wrapInProxy = exports.generateRandomHash = exports.convertResult = exports.functionFromScript = exports.getScript = exports.wrapScope = undefined;var _regenerator = require("@babel/runtime/regenerator");var _regeneratorRuntime = (0, _interopRequireDefault2["default"])(_regenerator)["default"];var _typeof2 = require("@babel/runtime/helpers/typeof");var _typeof = (0, _interopRequireDefault2["default"])(_typeof2)["default"];var _underscore = require("underscore");var _ = (0, _interopRequireDefault2["default"])(_underscore)["default"];

var _md = require("md5");var md5 = (0, _interopRequireDefault2["default"])(_md)["default"];
var _ejson = require("ejson");var EJSON = (0, _interopRequireDefault2["default"])(_ejson)["default"];
var _vm = require("vm");var vm = (0, _interopRequireDefault2["default"])(_vm)["default"];



var _MalibunCache = require("./MalibunCache");var MalibunCache = (0, _interopRequireDefault2["default"])(_MalibunCache)["default"];
var _cachedRegExp = require("./cachedRegExp");var cachedRegExp = (0, _interopRequireDefault2["default"])(_cachedRegExp)["default"];






var _generator = require("@babel/generator");var babelGenerate = (0, _interopRequireDefault2["default"])(_generator)["default"];var esprima = require('esprima');var escodegen = require('escodegen');var fbCache = new MalibunCache();var functionGenerator = new vm.Script("new Function( vm2Options.functionBody );");var scriptCache = new MalibunCache();var re = cachedRegExp(/^([\s\t\n\r]*return[\s\t\n\r]*)?(\{[\s\S]*\})([\s\t\n\r;]?$)/);var babelParser = require("@babel/parser");
var babelCore = require("@babel/core");

function generateRandomHash() {
  return md5(_.random(100000000) + '_' + _.random(100000000) + '_' + Date.now());
}

var functionFromScript = function functionFromScript(expr, vmCtx) {
  vmCtx.vm2Options = vmCtx.vm2Options || {};
  var vm2OptionsHash = vmCtx.vm2Options.hash;
  if (!vm2OptionsHash) {
    vm2OptionsHash = generateRandomHash();
  }
  var key = md5(expr + ':' + vm2OptionsHash);
  if (re.test(expr)) {
    re.lastIndex = 0;
    expr = expr.replace(re, function (m, prefix, body, suffix) {
      if (prefix === undefined)
      prefix = '';
      if (suffix === undefined)
      suffix = '';
      return "".concat(prefix, " new Object(").concat(body, ")").concat(suffix);
    });
  }

  if (!fbCache.has(key)) {
    var tokens = null;
    var parserMode = 'esprima';
    try {
      tokens = esprima.parseScript(expr, { tolerant: true });
    } catch (err1) {
      try {
        tokens = esprima.parseScript("(function anonymous(){ ".concat(expr, " }).apply( this );"), { tolerant: true });
      } catch (err2) {
        try {
          parserMode = 'babel';
          tokens = babelParser.parse(expr, {
            sourceType: "script",
            plugins: [
            ['decorators', { decoratorsBeforeExport: false }]],

            allowReturnOutsideFunction: true });

        } catch (err3) {
          throw err2;
        }
      }
    }
    if (parserMode == 'esprima') {
      var lastIndex = 0;
      _.each(tokens.body, function (statement, index) {
        if (statement.type != 'EmptyStatement') {
          lastIndex = index;
        }
      });
      var lastExpression = tokens.body[lastIndex];
      if (lastExpression) {
        if (['IfStatement', 'ReturnStatement'].indexOf(lastExpression.type) == -1) {
          tokens.body[tokens.body.length - 1] = {
            type: 'ReturnStatement',
            argument: lastExpression };

        }
        var functionBody = escodegen.generate(tokens);
        //console.log(functionBody);
        vmCtx.vm2Options.functionBody = functionBody;
        var f = functionGenerator.runInContext(vmCtx);
        //var f = new Function(functionBody);
        fbCache.set(key, f, 5 * 60 * 1000);
      }
    } else {
      var _lastIndex = 0;
      _.each(tokens.program.body, function (statement, index) {
        if (statement.type != 'EmptyStatement') {
          _lastIndex = index;
        }
      });
      var _lastExpression = tokens.program.body[_lastIndex];
      if (_lastExpression) {
        if (_lastExpression.type !== 'ReturnStatement') {
          throw new Error('Babel парсер ожидает return');
        }
        /*if (['IfStatement', 'ReturnStatement'].indexOf (lastExpression.type) == -1) {
              if(lastExpression.type==='ClassDeclaration')
                  lastExpression.type='ClassExpression';
              tokens.program.body[tokens.program.body.length - 1] = {
                  type: 'ReturnStatement',
                  argument: lastExpression,
              };
          }*/var _babelCore$transformF =

        babelCore.transformFromAstSync(tokens, expr, {
          "presets": [["@babel/preset-env", { targets: { node: true, esmodules: false } }]],
          "plugins": [
          "@babel/plugin-transform-runtime",
          ["@babel/plugin-syntax-dynamic-import"],
          ["@babel/plugin-proposal-optional-chaining"],
          ["@babel/plugin-proposal-decorators", { "legacy": true }]
          /*["transform-es2015-modules-commonjs-simple", {
                                                                        "noMangle": true
                                                                    }]*/],

          "sourceMaps": false,
          "retainLines": true }),code = _babelCore$transformF.code,map = _babelCore$transformF.map,ast = _babelCore$transformF.ast;

        //console.log(code);
        vmCtx.vm2Options.functionBody = code;
        var _f = functionGenerator.runInContext(vmCtx);
        //var f = new Function(functionBody);
        fbCache.set(key, _f, 5 * 60 * 1000);
      }
    }
  }
  return fbCache.get(key);
};


/**
    * @returns {Object} scope
    * @returns {Object} scope.vm
    * @returns {Object} scope.original
    * @param {VMRunner} runner
    * */
function wrapScope(scope, runner, vm2Options) {
  var scopeCopy = {}; //Object.assign({},scope);

  _.each(scope, function (instance, key) {
    var wrapped = null;
    if (_.isObject(instance)) {
      wrapped = new Proxy(instance, {
        get: function get(target, property) {
          return target[property];
        },
        set: function set(target, key, value, receiver) {
          //console.log('set key:',key,'value:',value);
        },
        getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
          return Object.getOwnPropertyDescriptor(target, name);
        },
        ownKeys: function ownKeys(target) {
          return Object.getOwnPropertyNames(target);
        },
        defineProperty: function defineProperty(target, name, propertyDescriptor) {

        },
        deleteProperty: function deleteProperty(target, name) {

        },
        preventExtensions: function preventExtensions(target) {

        },
        has: function has(target, name) {
          return name in target;
        } });

    } else {
      wrapped = instance;
    }
    scopeCopy[key] = wrapped;
  });

  scopeCopy.vm2Options = vm2Options;

  var vmContext = vm.createContext(scopeCopy);
  return {
    vm: vmContext,
    original: scopeCopy };

}

function getScript(code) {
  if (!_.isString(code) || !code) {
    return null;
  }
  if (!scriptCache.has(code)) {
    try {
      var script = new vm.Script(code);
      scriptCache.set(code, script, 5 * 60 * 1000);
    } catch (e) {
      return null;
    }
  }
  return scriptCache.get(code);
}

function convertResult(result) {var converted, check;return _regeneratorRuntime.async(function convertResult$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
          converted = result;if (!
          _.isDate(result)) {_context.next = 5;break;}
          converted = new Date(result.getTime());_context.next = 12;break;case 5:if (!(
          result && _.isFunction(result.then))) {_context.next = 11;break;}_context.next = 8;return _regeneratorRuntime.awrap(
          result);case 8:converted = _context.sent;_context.next = 12;break;case 11:
          if (result && _typeof(result) == 'object') {

            check = function check(target, source, key) {
              var val = source[key];
              if (typeof val == 'function') {
                target[key] = val;
              } else if (_.isDate(val)) {
                target[key] = new Date(val);
              } else if (_.isArray(val) || _.isObject(val)) {
                _.each(_.keys(val), function (valKey) {
                  check(target[key], val, valKey);
                });
              }
            };converted = EJSON.clone(result);
            _.each(_.keys(result), function (key) {
              check(converted, result, key);
            });
          }case 12:return _context.abrupt("return",
          converted);case 13:case "end":return _context.stop();}}});}


function wrapInProxy(instance) {
  return new Proxy(instance, {
    get: function get(target, property) {
      return target[property];
    },
    set: function set(target, key, value, receiver) {

    },
    getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
      return Object.getOwnPropertyDescriptor(target, name);
    },
    ownKeys: function ownKeys(target) {
      return Object.getOwnPropertyNames(target);
    },
    defineProperty: function defineProperty(target, name, propertyDescriptor) {

    },
    deleteProperty: function deleteProperty(target, name) {

    },
    preventExtensions: function preventExtensions(target) {

    },
    has: function has(target, name) {
      return name in target;
    } });

}exports.



wrapScope = wrapScope;exports.getScript = getScript;exports.functionFromScript = functionFromScript;exports.convertResult = convertResult;exports.generateRandomHash = generateRandomHash;exports.wrapInProxy = wrapInProxy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJfIiwibWQ1IiwiRUpTT04iLCJ2bSIsIk1hbGlidW5DYWNoZSIsImNhY2hlZFJlZ0V4cCIsImJhYmVsR2VuZXJhdGUiLCJlc3ByaW1hIiwicmVxdWlyZSIsImVzY29kZWdlbiIsImZiQ2FjaGUiLCJmdW5jdGlvbkdlbmVyYXRvciIsIlNjcmlwdCIsInNjcmlwdENhY2hlIiwicmUiLCJiYWJlbFBhcnNlciIsImJhYmVsQ29yZSIsImdlbmVyYXRlUmFuZG9tSGFzaCIsInJhbmRvbSIsIkRhdGUiLCJub3ciLCJmdW5jdGlvbkZyb21TY3JpcHQiLCJleHByIiwidm1DdHgiLCJ2bTJPcHRpb25zIiwidm0yT3B0aW9uc0hhc2giLCJoYXNoIiwia2V5IiwidGVzdCIsImxhc3RJbmRleCIsInJlcGxhY2UiLCJtIiwicHJlZml4IiwiYm9keSIsInN1ZmZpeCIsInVuZGVmaW5lZCIsImhhcyIsInRva2VucyIsInBhcnNlck1vZGUiLCJwYXJzZVNjcmlwdCIsInRvbGVyYW50IiwiZXJyMSIsImVycjIiLCJwYXJzZSIsInNvdXJjZVR5cGUiLCJwbHVnaW5zIiwiZGVjb3JhdG9yc0JlZm9yZUV4cG9ydCIsImFsbG93UmV0dXJuT3V0c2lkZUZ1bmN0aW9uIiwiZXJyMyIsImVhY2giLCJzdGF0ZW1lbnQiLCJpbmRleCIsInR5cGUiLCJsYXN0RXhwcmVzc2lvbiIsImluZGV4T2YiLCJsZW5ndGgiLCJhcmd1bWVudCIsImZ1bmN0aW9uQm9keSIsImdlbmVyYXRlIiwiZiIsInJ1bkluQ29udGV4dCIsInNldCIsInByb2dyYW0iLCJFcnJvciIsInRyYW5zZm9ybUZyb21Bc3RTeW5jIiwidGFyZ2V0cyIsIm5vZGUiLCJlc21vZHVsZXMiLCJjb2RlIiwibWFwIiwiYXN0IiwiZ2V0Iiwid3JhcFNjb3BlIiwic2NvcGUiLCJydW5uZXIiLCJzY29wZUNvcHkiLCJpbnN0YW5jZSIsIndyYXBwZWQiLCJpc09iamVjdCIsIlByb3h5IiwidGFyZ2V0IiwicHJvcGVydHkiLCJ2YWx1ZSIsInJlY2VpdmVyIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwibmFtZSIsIk9iamVjdCIsIm93bktleXMiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwiZGVmaW5lUHJvcGVydHkiLCJwcm9wZXJ0eURlc2NyaXB0b3IiLCJkZWxldGVQcm9wZXJ0eSIsInByZXZlbnRFeHRlbnNpb25zIiwidm1Db250ZXh0IiwiY3JlYXRlQ29udGV4dCIsIm9yaWdpbmFsIiwiZ2V0U2NyaXB0IiwiaXNTdHJpbmciLCJzY3JpcHQiLCJlIiwiY29udmVydFJlc3VsdCIsInJlc3VsdCIsImNvbnZlcnRlZCIsImlzRGF0ZSIsImdldFRpbWUiLCJpc0Z1bmN0aW9uIiwidGhlbiIsImNoZWNrIiwic291cmNlIiwidmFsIiwiaXNBcnJheSIsImtleXMiLCJ2YWxLZXkiLCJjbG9uZSIsIndyYXBJblByb3h5Il0sIm1hcHBpbmdzIjoiaXNCQUFBLHdDLElBQU9BLEM7O0FBRVAseUIsSUFBT0MsRztBQUNQLDhCLElBQU9DLEs7QUFDUCx3QixJQUFPQyxFOzs7O0FBSVAsOEMsSUFBT0MsWTtBQUNQLDhDLElBQU9DLFk7Ozs7Ozs7QUFPUCw2QyxJQUFPQyxhLGtFQVZQLElBQU1DLE9BQU8sR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBdkIsQ0FDQSxJQUFNQyxTQUFTLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQXpCLENBSUEsSUFBTUUsT0FBTyxHQUFHLElBQUlOLFlBQUosRUFBaEIsQ0FDQSxJQUFNTyxpQkFBaUIsR0FBRyxJQUFJUixFQUFFLENBQUNTLE1BQVAsNENBQTFCLENBQ0EsSUFBTUMsV0FBVyxHQUFHLElBQUlULFlBQUosRUFBcEIsQ0FDQSxJQUFNVSxFQUFFLEdBQUdULFlBQVksQ0FBQyw4REFBRCxDQUF2QixDQUNBLElBQU1VLFdBQVcsR0FBR1AsT0FBTyxDQUFDLGVBQUQsQ0FBM0I7QUFFQSxJQUFNUSxTQUFTLEdBQUdSLE9BQU8sQ0FBQyxhQUFELENBQXpCOztBQUVBLFNBQVNT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QUFBLGlCQW5Cc0IsNkJBbUJKWixNQW5CSSxFQW1CRzs7QUFFeEIsS0FyQnFCO0FBc0J0QjVDLElBQUFBLEdBdEJzQixlQXNCbEI0QyxNQXRCa0IsRUFzQlZLLElBdEJVLEVBc0JMO0FBQ2IsYUFBT0EsSUFBSSxJQUFJTCxNQUFmO0FBQ0gsS0F4QnFCLEVBQW5CLENBQVA7O0FBMEJILEM7Ozs7QUFJR1IsUyxHQUFBQSxTLFNBQVV3QixTLEdBQUFBLFMsU0FBVTNFLGtCLEdBQUFBLGtCLFNBQW1CK0UsYSxHQUFBQSxhLFNBQWNuRixrQixHQUFBQSxrQixTQUFtQmlHLFcsR0FBQUEsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnO1xuXG5pbXBvcnQgbWQ1IGZyb20gJ21kNSc7XG5pbXBvcnQgRUpTT04gZnJvbSAnZWpzb24nO1xuaW1wb3J0IHZtIGZyb20gJ3ZtJztcblxuY29uc3QgZXNwcmltYSA9IHJlcXVpcmUoJ2VzcHJpbWEnKTtcbmNvbnN0IGVzY29kZWdlbiA9IHJlcXVpcmUoJ2VzY29kZWdlbicpO1xuaW1wb3J0IE1hbGlidW5DYWNoZSBmcm9tIFwiLi9NYWxpYnVuQ2FjaGVcIjtcbmltcG9ydCBjYWNoZWRSZWdFeHAgZnJvbSAnLi9jYWNoZWRSZWdFeHAnO1xuXG5jb25zdCBmYkNhY2hlID0gbmV3IE1hbGlidW5DYWNoZSgpO1xuY29uc3QgZnVuY3Rpb25HZW5lcmF0b3IgPSBuZXcgdm0uU2NyaXB0KCBgbmV3IEZ1bmN0aW9uKCB2bTJPcHRpb25zLmZ1bmN0aW9uQm9keSApO2AgKTtcbmNvbnN0IHNjcmlwdENhY2hlID0gbmV3IE1hbGlidW5DYWNoZSgpO1xuY29uc3QgcmUgPSBjYWNoZWRSZWdFeHAoL14oW1xcc1xcdFxcblxccl0qcmV0dXJuW1xcc1xcdFxcblxccl0qKT8oXFx7W1xcc1xcU10qXFx9KShbXFxzXFx0XFxuXFxyO10/JCkvKTtcbmNvbnN0IGJhYmVsUGFyc2VyID0gcmVxdWlyZShcIkBiYWJlbC9wYXJzZXJcIik7XG5pbXBvcnQgYmFiZWxHZW5lcmF0ZSBmcm9tICdAYmFiZWwvZ2VuZXJhdG9yJztcbmNvbnN0IGJhYmVsQ29yZSA9IHJlcXVpcmUoXCJAYmFiZWwvY29yZVwiKVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUhhc2goKSB7XG4gICAgcmV0dXJuIG1kNShfLnJhbmRvbSgxMDAwMDAwMDApICsgJ18nICsgXy5yYW5kb20oMTAwMDAwMDAwKSArICdfJyArIERhdGUubm93KCkpO1xufVxuXG5jb25zdCBmdW5jdGlvbkZyb21TY3JpcHQgPSBmdW5jdGlvbihleHByLHZtQ3R4KXtcbiAgICB2bUN0eC52bTJPcHRpb25zID0gdm1DdHgudm0yT3B0aW9ucyB8fCB7fTtcbiAgICBsZXQgdm0yT3B0aW9uc0hhc2ggPSB2bUN0eC52bTJPcHRpb25zLmhhc2g7XG4gICAgaWYoIXZtMk9wdGlvbnNIYXNoKXtcbiAgICAgICAgdm0yT3B0aW9uc0hhc2ggPSBnZW5lcmF0ZVJhbmRvbUhhc2goKTtcbiAgICB9XG4gICAgbGV0IGtleSA9IG1kNSggZXhwcisnOicrdm0yT3B0aW9uc0hhc2ggICk7XG4gICAgaWYocmUudGVzdChleHByKSl7XG4gICAgICAgIHJlLmxhc3RJbmRleCA9IDA7XG4gICAgICAgIGV4cHIgPSBleHByLnJlcGxhY2UocmUsKG0scHJlZml4LGJvZHksc3VmZml4KT0+e1xuICAgICAgICAgICAgaWYocHJlZml4PT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgIHByZWZpeCA9ICcnO1xuICAgICAgICAgICAgaWYoc3VmZml4PT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgIHN1ZmZpeCA9ICcnO1xuICAgICAgICAgICAgcmV0dXJuIGAke3ByZWZpeH0gbmV3IE9iamVjdCgke2JvZHl9KSR7c3VmZml4fWA7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmKCFmYkNhY2hlLmhhcyhrZXkpKSB7XG4gICAgICAgIGxldCB0b2tlbnMgPSBudWxsO1xuICAgICAgICBsZXQgcGFyc2VyTW9kZSA9ICdlc3ByaW1hJztcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgdG9rZW5zID0gZXNwcmltYS5wYXJzZVNjcmlwdChleHByLHt0b2xlcmFudDp0cnVlfSk7XG4gICAgICAgIH1jYXRjaCAoZXJyMSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICB0b2tlbnMgPSBlc3ByaW1hLnBhcnNlU2NyaXB0KGAoZnVuY3Rpb24gYW5vbnltb3VzKCl7ICR7ZXhwcn0gfSkuYXBwbHkoIHRoaXMgKTtgLHt0b2xlcmFudDp0cnVlfSlcbiAgICAgICAgICAgIH1jYXRjaCAoZXJyMikge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnNlck1vZGUgPSAnYmFiZWwnO1xuICAgICAgICAgICAgICAgICAgICB0b2tlbnMgPSBiYWJlbFBhcnNlci5wYXJzZShleHByLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VUeXBlOiBcInNjcmlwdFwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGx1Z2luczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsnZGVjb3JhdG9ycycsIHsgZGVjb3JhdG9yc0JlZm9yZUV4cG9ydDogZmFsc2UgfV1cbiAgICAgICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd1JldHVybk91dHNpZGVGdW5jdGlvbjp0cnVlLFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9Y2F0Y2ggKGVycjMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyMjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYocGFyc2VyTW9kZT09J2VzcHJpbWEnKSB7XG4gICAgICAgICAgICBsZXQgbGFzdEluZGV4ID0gMDtcbiAgICAgICAgICAgIF8uZWFjaCAodG9rZW5zLmJvZHksIChzdGF0ZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudC50eXBlICE9ICdFbXB0eVN0YXRlbWVudCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFzdEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsZXQgbGFzdEV4cHJlc3Npb24gPSB0b2tlbnMuYm9keVtsYXN0SW5kZXhdO1xuICAgICAgICAgICAgaWYgKGxhc3RFeHByZXNzaW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKFsnSWZTdGF0ZW1lbnQnLCAnUmV0dXJuU3RhdGVtZW50J10uaW5kZXhPZiAobGFzdEV4cHJlc3Npb24udHlwZSkgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLmJvZHlbdG9rZW5zLmJvZHkubGVuZ3RoIC0gMV0gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnUmV0dXJuU3RhdGVtZW50JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50OiBsYXN0RXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGZ1bmN0aW9uQm9keSA9IGVzY29kZWdlbi5nZW5lcmF0ZSAodG9rZW5zKTtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGZ1bmN0aW9uQm9keSk7XG4gICAgICAgICAgICAgICAgdm1DdHgudm0yT3B0aW9ucy5mdW5jdGlvbkJvZHkgPSBmdW5jdGlvbkJvZHk7XG4gICAgICAgICAgICAgICAgbGV0IGYgPSBmdW5jdGlvbkdlbmVyYXRvci5ydW5JbkNvbnRleHQgKHZtQ3R4KTtcbiAgICAgICAgICAgICAgICAvL3ZhciBmID0gbmV3IEZ1bmN0aW9uKGZ1bmN0aW9uQm9keSk7XG4gICAgICAgICAgICAgICAgZmJDYWNoZS5zZXQgKGtleSwgZiwgNSAqIDYwICogMTAwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgbGV0IGxhc3RJbmRleCA9IDA7XG4gICAgICAgICAgICBfLmVhY2ggKHRva2Vucy5wcm9ncmFtLmJvZHksIChzdGF0ZW1lbnQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudC50eXBlICE9ICdFbXB0eVN0YXRlbWVudCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGFzdEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsZXQgbGFzdEV4cHJlc3Npb24gPSB0b2tlbnMucHJvZ3JhbS5ib2R5W2xhc3RJbmRleF07XG4gICAgICAgICAgICBpZiAobGFzdEV4cHJlc3Npb24pIHtcbiAgICAgICAgICAgICAgICBpZihsYXN0RXhwcmVzc2lvbi50eXBlIT09J1JldHVyblN0YXRlbWVudCcpe1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhYmVsINC/0LDRgNGB0LXRgCDQvtC20LjQtNCw0LXRgiByZXR1cm4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLyppZiAoWydJZlN0YXRlbWVudCcsICdSZXR1cm5TdGF0ZW1lbnQnXS5pbmRleE9mIChsYXN0RXhwcmVzc2lvbi50eXBlKSA9PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICBpZihsYXN0RXhwcmVzc2lvbi50eXBlPT09J0NsYXNzRGVjbGFyYXRpb24nKVxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEV4cHJlc3Npb24udHlwZT0nQ2xhc3NFeHByZXNzaW9uJztcbiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnByb2dyYW0uYm9keVt0b2tlbnMucHJvZ3JhbS5ib2R5Lmxlbmd0aCAtIDFdID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1JldHVyblN0YXRlbWVudCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmd1bWVudDogbGFzdEV4cHJlc3Npb24sXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSovXG5cbiAgICAgICAgICAgICAgICBjb25zdCB7IGNvZGUsIG1hcCwgYXN0IH0gPSBiYWJlbENvcmUudHJhbnNmb3JtRnJvbUFzdFN5bmModG9rZW5zLCBleHByLCB7XG4gICAgICAgICAgICAgICAgICAgIFwicHJlc2V0c1wiOiBbW1wiQGJhYmVsL3ByZXNldC1lbnZcIix7dGFyZ2V0czp7bm9kZTp0cnVlLGVzbW9kdWxlczpmYWxzZX19XV0sXG4gICAgICAgICAgICAgICAgICAgIFwicGx1Z2luc1wiOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICBcIkBiYWJlbC9wbHVnaW4tdHJhbnNmb3JtLXJ1bnRpbWVcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFtcIkBiYWJlbC9wbHVnaW4tc3ludGF4LWR5bmFtaWMtaW1wb3J0XCJdLFxuICAgICAgICAgICAgICAgICAgICAgICAgW1wiQGJhYmVsL3BsdWdpbi1wcm9wb3NhbC1vcHRpb25hbC1jaGFpbmluZ1wiXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFtcIkBiYWJlbC9wbHVnaW4tcHJvcG9zYWwtZGVjb3JhdG9yc1wiLCB7XCJsZWdhY3lcIjogdHJ1ZX1dLFxuICAgICAgICAgICAgICAgICAgICAgICAgLypbXCJ0cmFuc2Zvcm0tZXMyMDE1LW1vZHVsZXMtY29tbW9uanMtc2ltcGxlXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIm5vTWFuZ2xlXCI6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH1dKi9cbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICAgICAgXCJzb3VyY2VNYXBzXCI6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICBcInJldGFpbkxpbmVzXCI6IHRydWVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGNvZGUpO1xuICAgICAgICAgICAgICAgIHZtQ3R4LnZtMk9wdGlvbnMuZnVuY3Rpb25Cb2R5ID0gY29kZTtcbiAgICAgICAgICAgICAgICBsZXQgZiA9IGZ1bmN0aW9uR2VuZXJhdG9yLnJ1bkluQ29udGV4dCAodm1DdHgpO1xuICAgICAgICAgICAgICAgIC8vdmFyIGYgPSBuZXcgRnVuY3Rpb24oZnVuY3Rpb25Cb2R5KTtcbiAgICAgICAgICAgICAgICBmYkNhY2hlLnNldCAoa2V5LCBmLCA1ICogNjAgKiAxMDAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmJDYWNoZS5nZXQoa2V5KTtcbn07XG5cblxuLyoqXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBzY29wZVxuICogQHJldHVybnMge09iamVjdH0gc2NvcGUudm1cbiAqIEByZXR1cm5zIHtPYmplY3R9IHNjb3BlLm9yaWdpbmFsXG4gKiBAcGFyYW0ge1ZNUnVubmVyfSBydW5uZXJcbiAqICovXG5mdW5jdGlvbiB3cmFwU2NvcGUoc2NvcGUscnVubmVyLHZtMk9wdGlvbnMpe1xuICAgIGxldCBzY29wZUNvcHkgPSB7fTsvL09iamVjdC5hc3NpZ24oe30sc2NvcGUpO1xuXG4gICAgXy5lYWNoKHNjb3BlLChpbnN0YW5jZSxrZXkpPT57XG4gICAgICAgIGxldCB3cmFwcGVkID0gbnVsbDtcbiAgICAgICAgaWYoXy5pc09iamVjdChpbnN0YW5jZSkgKXtcbiAgICAgICAgICAgIHdyYXBwZWQgPSBuZXcgUHJveHkoaW5zdGFuY2Use1xuICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24odGFyZ2V0LCBwcm9wZXJ0eSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BlcnR5XTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnc2V0IGtleTonLGtleSwndmFsdWU6Jyx2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG93bktleXModGFyZ2V0KXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRhcmdldCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIG5hbWUsIHByb3BlcnR5RGVzY3JpcHRvcil7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwgbmFtZSl7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHByZXZlbnRFeHRlbnNpb25zKHRhcmdldCl7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGhhcyh0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmFtZSBpbiB0YXJnZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgd3JhcHBlZCA9IGluc3RhbmNlO1xuICAgICAgICB9XG4gICAgICAgIHNjb3BlQ29weVtrZXldID0gd3JhcHBlZDtcbiAgICB9KTtcblxuICAgIHNjb3BlQ29weS52bTJPcHRpb25zID0gdm0yT3B0aW9ucztcblxuICAgIGxldCB2bUNvbnRleHQgPSB2bS5jcmVhdGVDb250ZXh0KCBzY29wZUNvcHkgKTtcbiAgICByZXR1cm4ge1xuICAgICAgICB2bTp2bUNvbnRleHQsXG4gICAgICAgIG9yaWdpbmFsOnNjb3BlQ29weVxuICAgIH1cbn1cblxuZnVuY3Rpb24gZ2V0U2NyaXB0KGNvZGUpe1xuICAgIGlmKCFfLmlzU3RyaW5nKGNvZGUpfHwhY29kZSl7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBpZighc2NyaXB0Q2FjaGUuaGFzKGNvZGUpKXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNjcmlwdCA9IG5ldyB2bS5TY3JpcHQoY29kZSk7XG4gICAgICAgICAgICBzY3JpcHRDYWNoZS5zZXQoY29kZSwgc2NyaXB0LCA1ICogNjAgKiAxMDAwKTtcbiAgICAgICAgfWNhdGNoKGUpe1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNjcmlwdENhY2hlLmdldChjb2RlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29udmVydFJlc3VsdChyZXN1bHQpe1xuICAgIGxldCBjb252ZXJ0ZWQgPSByZXN1bHQ7XG4gICAgaWYoXy5pc0RhdGUocmVzdWx0KSl7XG4gICAgICAgIGNvbnZlcnRlZCA9IG5ldyBEYXRlKCByZXN1bHQuZ2V0VGltZSgpICk7XG4gICAgfWVsc2UgaWYocmVzdWx0ICYmIF8uaXNGdW5jdGlvbihyZXN1bHQudGhlbikpe1xuICAgICAgICBjb252ZXJ0ZWQgPSBhd2FpdCByZXN1bHQ7XG4gICAgfWVsc2UgaWYocmVzdWx0JiZ0eXBlb2YgcmVzdWx0PT0nb2JqZWN0Jyl7XG4gICAgICAgIGNvbnZlcnRlZCA9IEVKU09OLmNsb25lKHJlc3VsdCk7XG4gICAgICAgIGZ1bmN0aW9uIGNoZWNrKHRhcmdldCxzb3VyY2Usa2V5KXtcbiAgICAgICAgICAgIGxldCB2YWwgPSBzb3VyY2Vba2V5XTtcbiAgICAgICAgICAgIGlmKHR5cGVvZiB2YWw9PSdmdW5jdGlvbicpe1xuICAgICAgICAgICAgICAgIHRhcmdldFtrZXldPXZhbDtcbiAgICAgICAgICAgIH1lbHNlIGlmKF8uaXNEYXRlKHZhbCkpe1xuICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gbmV3IERhdGUoIHZhbCApO1xuICAgICAgICAgICAgfWVsc2UgaWYoXy5pc0FycmF5KHZhbCl8fF8uaXNPYmplY3QodmFsKSl7XG4gICAgICAgICAgICAgICAgXy5lYWNoKF8ua2V5cyh2YWwpLCh2YWxLZXkpPT57XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrKCB0YXJnZXRba2V5XSAsIHZhbCwgdmFsS2V5KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBfLmVhY2goXy5rZXlzKHJlc3VsdCksKGtleSk9PntcbiAgICAgICAgICAgIGNoZWNrKGNvbnZlcnRlZCxyZXN1bHQsa2V5KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjb252ZXJ0ZWQ7XG59XG5cbmZ1bmN0aW9uIHdyYXBJblByb3h5KGluc3RhbmNlKXtcbiAgICByZXR1cm4gbmV3IFByb3h5KGluc3RhbmNlLHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5KSB7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BlcnR5XTtcbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcikge1xuXG4gICAgICAgIH0sXG4gICAgICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgICAgfSxcbiAgICAgICAgb3duS2V5cyh0YXJnZXQpe1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRhcmdldCk7XG4gICAgICAgIH0sXG4gICAgICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwgbmFtZSwgcHJvcGVydHlEZXNjcmlwdG9yKXtcblxuICAgICAgICB9LFxuICAgICAgICBkZWxldGVQcm9wZXJ0eSh0YXJnZXQsIG5hbWUpe1xuXG4gICAgICAgIH0sXG4gICAgICAgIHByZXZlbnRFeHRlbnNpb25zKHRhcmdldCl7XG5cbiAgICAgICAgfSxcbiAgICAgICAgaGFzKHRhcmdldCwgbmFtZSl7XG4gICAgICAgICAgICByZXR1cm4gbmFtZSBpbiB0YXJnZXQ7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuXG5leHBvcnQge1xuICAgIHdyYXBTY29wZSxnZXRTY3JpcHQsZnVuY3Rpb25Gcm9tU2NyaXB0LGNvbnZlcnRSZXN1bHQsZ2VuZXJhdGVSYW5kb21IYXNoLHdyYXBJblByb3h5XG59XG5cbiJdfQ==