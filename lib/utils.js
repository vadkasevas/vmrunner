"use strict";var _interopRequireDefault3 = require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireDefault2 = _interopRequireDefault3(require("@babel/runtime/helpers/interopRequireDefault"));Object.defineProperty(exports, "__esModule", { value: true });exports.wrapInProxy = exports.generateRandomHash = exports.convertResult = exports.functionFromScript = exports.getScript = exports.wrapScope = undefined;var _regenerator = require("@babel/runtime/regenerator");var _regeneratorRuntime = (0, _interopRequireDefault2["default"])(_regenerator)["default"];var _typeof2 = require("@babel/runtime/helpers/typeof");var _typeof = (0, _interopRequireDefault2["default"])(_typeof2)["default"];var _underscore = require("underscore");var _ = (0, _interopRequireDefault2["default"])(_underscore)["default"];

var _md = require("md5");var md5 = (0, _interopRequireDefault2["default"])(_md)["default"];
var _ejson = require("ejson");var EJSON = (0, _interopRequireDefault2["default"])(_ejson)["default"];
var _vm = require("vm");var vm = (0, _interopRequireDefault2["default"])(_vm)["default"];



var _MalibunCache = require("./MalibunCache");var MalibunCache = (0, _interopRequireDefault2["default"])(_MalibunCache)["default"];
var _cachedRegExp = require("./cachedRegExp");var cachedRegExp = (0, _interopRequireDefault2["default"])(_cachedRegExp)["default"];var esprima = require('esprima');var escodegen = require('escodegen');

var fbCache = new MalibunCache();
var functionGenerator = new vm.Script("new Function( vm2Options.functionBody );");
var scriptCache = new MalibunCache();
var re = cachedRegExp(/^([\s\t\n\r]*return[\s\t\n\r]*)?(\{[\s\S]*\})([\s\t\n\r;]?$)/);

function generateRandomHash() {
  return md5(_.random(100000000) + '_' + _.random(100000000) + '_' + Date.now());
}

var functionFromScript = function functionFromScript(expr, vmCtx) {
  vmCtx.vm2Options = vmCtx.vm2Options || {};
  var vm2OptionsHash = vmCtx.vm2Options.hash;
  if (!vm2OptionsHash) {
    vm2OptionsHash = generateRandomHash();
  }
  var key = md5(expr + ':' + vm2OptionsHash);
  if (re.test(expr)) {
    re.lastIndex = 0;
    expr = expr.replace(re, function (m, prefix, body, suffix) {
      if (prefix === undefined)
      prefix = '';
      if (suffix === undefined)
      suffix = '';
      return "".concat(prefix, " new Object(").concat(body, ")").concat(suffix);
    });
  }

  if (!fbCache.has(key)) {
    var tokens = null;
    try {
      tokens = esprima.parseScript(expr, { tolerant: true });
    } catch (e) {
      tokens = esprima.parseScript("(function anonymous(){ ".concat(expr, " }).apply( this );"), { tolerant: true });
    }
    var lastIndex = 0;
    _.each(tokens.body, function (statement, index) {
      if (statement.type != 'EmptyStatement') {
        lastIndex = index;
      }
    });
    var lastExpression = tokens.body[lastIndex];
    if (lastExpression) {
      if (['IfStatement', 'ReturnStatement'].indexOf(lastExpression.type) == -1) {
        tokens.body[tokens.body.length - 1] = {
          type: 'ReturnStatement',
          argument: lastExpression };

      }
      var functionBody = escodegen.generate(tokens);
      //console.log(functionBody);


      vmCtx.vm2Options.functionBody = functionBody;
      var f = functionGenerator.runInContext(vmCtx);

      //var f = new Function(functionBody);
      fbCache.set(key, f, 5 * 60 * 1000);
    }
  }
  return fbCache.get(key);
};


/**
    * @returns {Object} scope
    * @returns {Object} scope.vm
    * @returns {Object} scope.original
    * @param {VMRunner} runner
    * */
function wrapScope(scope, runner, vm2Options) {
  var scopeCopy = {}; //Object.assign({},scope);

  _.each(scope, function (instance, key) {
    var wrapped = null;
    if (_.isObject(instance)) {
      wrapped = new Proxy(instance, {
        get: function get(target, property) {
          return target[property];
        },
        set: function set(target, key, value, receiver) {
          //console.log('set key:',key,'value:',value);
        },
        getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
          return Object.getOwnPropertyDescriptor(target, name);
        },
        ownKeys: function ownKeys(target) {
          return Object.getOwnPropertyNames(target);
        },
        defineProperty: function defineProperty(target, name, propertyDescriptor) {

        },
        deleteProperty: function deleteProperty(target, name) {

        },
        preventExtensions: function preventExtensions(target) {

        },
        has: function has(target, name) {
          return name in target;
        } });

    } else {
      wrapped = instance;
    }
    scopeCopy[key] = wrapped;
  });

  scopeCopy.vm2Options = vm2Options;

  var vmContext = vm.createContext(scopeCopy);
  return {
    vm: vmContext,
    original: scopeCopy };

}

function getScript(code) {
  if (!_.isString(code) || !code) {
    return null;
  }
  if (!scriptCache.has(code)) {
    try {
      var script = new vm.Script(code);
      scriptCache.set(code, script, 5 * 60 * 1000);
    } catch (e) {
      return null;
    }
  }
  return scriptCache.get(code);
}

function convertResult(result) {var converted, check;return _regeneratorRuntime.async(function convertResult$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
          converted = result;if (!
          _.isDate(result)) {_context.next = 5;break;}
          converted = new Date(result.getTime());_context.next = 12;break;case 5:if (!(
          result && _.isFunction(result.then))) {_context.next = 11;break;}_context.next = 8;return _regeneratorRuntime.awrap(
          result);case 8:converted = _context.sent;_context.next = 12;break;case 11:
          if (result && _typeof(result) == 'object') {

            check = function check(target, source, key) {
              var val = source[key];
              if (typeof val == 'function') {
                target[key] = val;
              } else if (_.isDate(val)) {
                target[key] = new Date(val);
              } else if (_.isArray(val) || _.isObject(val)) {
                _.each(_.keys(val), function (valKey) {
                  check(target[key], val, valKey);
                });
              }
            };converted = EJSON.clone(result);
            _.each(_.keys(result), function (key) {
              check(converted, result, key);
            });
          }case 12:return _context.abrupt("return",
          converted);case 13:case "end":return _context.stop();}}});}


function wrapInProxy(instance) {
  return new Proxy(instance, {
    get: function get(target, property) {
      return target[property];
    },
    set: function set(target, key, value, receiver) {

    },
    getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
      return Object.getOwnPropertyDescriptor(target, name);
    },
    ownKeys: function ownKeys(target) {
      return Object.getOwnPropertyNames(target);
    },
    defineProperty: function defineProperty(target, name, propertyDescriptor) {

    },
    deleteProperty: function deleteProperty(target, name) {

    },
    preventExtensions: function preventExtensions(target) {

    },
    has: function has(target, name) {
      return name in target;
    } });

}exports.



wrapScope = wrapScope;exports.getScript = getScript;exports.functionFromScript = functionFromScript;exports.convertResult = convertResult;exports.generateRandomHash = generateRandomHash;exports.wrapInProxy = wrapInProxy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJfIiwibWQ1IiwiRUpTT04iLCJ2bSIsIk1hbGlidW5DYWNoZSIsImNhY2hlZFJlZ0V4cCIsImVzcHJpbWEiLCJyZXF1aXJlIiwiZXNjb2RlZ2VuIiwiZmJDYWNoZSIsImZ1bmN0aW9uR2VuZXJhdG9yIiwiU2NyaXB0Iiwic2NyaXB0Q2FjaGUiLCJyZSIsImdlbmVyYXRlUmFuZG9tSGFzaCIsInJhbmRvbSIsIkRhdGUiLCJub3ciLCJmdW5jdGlvbkZyb21TY3JpcHQiLCJleHByIiwidm1DdHgiLCJ2bTJPcHRpb25zIiwidm0yT3B0aW9uc0hhc2giLCJoYXNoIiwia2V5IiwidGVzdCIsImxhc3RJbmRleCIsInJlcGxhY2UiLCJtIiwicHJlZml4IiwiYm9keSIsInN1ZmZpeCIsInVuZGVmaW5lZCIsImhhcyIsInRva2VucyIsInBhcnNlU2NyaXB0IiwidG9sZXJhbnQiLCJlIiwiZWFjaCIsInN0YXRlbWVudCIsImluZGV4IiwidHlwZSIsImxhc3RFeHByZXNzaW9uIiwiaW5kZXhPZiIsImxlbmd0aCIsImFyZ3VtZW50IiwiZnVuY3Rpb25Cb2R5IiwiZ2VuZXJhdGUiLCJmIiwicnVuSW5Db250ZXh0Iiwic2V0IiwiZ2V0Iiwid3JhcFNjb3BlIiwic2NvcGUiLCJydW5uZXIiLCJzY29wZUNvcHkiLCJpbnN0YW5jZSIsIndyYXBwZWQiLCJpc09iamVjdCIsIlByb3h5IiwidGFyZ2V0IiwicHJvcGVydHkiLCJ2YWx1ZSIsInJlY2VpdmVyIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwibmFtZSIsIk9iamVjdCIsIm93bktleXMiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwiZGVmaW5lUHJvcGVydHkiLCJwcm9wZXJ0eURlc2NyaXB0b3IiLCJkZWxldGVQcm9wZXJ0eSIsInByZXZlbnRFeHRlbnNpb25zIiwidm1Db250ZXh0IiwiY3JlYXRlQ29udGV4dCIsIm9yaWdpbmFsIiwiZ2V0U2NyaXB0IiwiY29kZSIsImlzU3RyaW5nIiwic2NyaXB0IiwiY29udmVydFJlc3VsdCIsInJlc3VsdCIsImNvbnZlcnRlZCIsImlzRGF0ZSIsImdldFRpbWUiLCJpc0Z1bmN0aW9uIiwidGhlbiIsImNoZWNrIiwic291cmNlIiwidmFsIiwiaXNBcnJheSIsImtleXMiLCJ2YWxLZXkiLCJjbG9uZSIsIndyYXBJblByb3h5Il0sIm1hcHBpbmdzIjoiaXNCQUFBLHdDLElBQU9BLEM7O0FBRVAseUIsSUFBT0MsRztBQUNQLDhCLElBQU9DLEs7QUFDUCx3QixJQUFPQyxFOzs7O0FBSVAsOEMsSUFBT0MsWTtBQUNQLDhDLElBQU9DLFkscUVBSFAsSUFBTUMsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2QixDQUNBLElBQU1DLFNBQVMsR0FBR0QsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBSUEsSUFBTUUsT0FBTyxHQUFHLElBQUlMLFlBQUosRUFBaEI7QUFDQSxJQUFNTSxpQkFBaUIsR0FBRyxJQUFJUCxFQUFFLENBQUNRLE1BQVAsNENBQTFCO0FBQ0EsSUFBTUMsV0FBVyxHQUFHLElBQUlSLFlBQUosRUFBcEI7QUFDQSxJQUFNUyxFQUFFLEdBQUdSLFlBQVksQ0FBQyw4REFBRCxDQUF2Qjs7QUFFQSxTQUFTUyxrQkFBVCxHQUE4QjtBQUMxQixTQUFPYixHQUFHLENBQUNELENBQUMsQ0FBQ2UsTUFBRixDQUFTLFNBQVQsSUFBc0IsR0FBdEIsR0FBNEJmLENBQUMsQ0FBQ2UsTUFBRixDQUFTLFNBQVQsQ0FBNUIsR0FBa0QsR0FBbEQsR0FBd0RDLElBQUksQ0FBQ0MsR0FBTCxFQUF6RCxDQUFWO0FBQ0g7O0FBRUQsSUFBTUMsa0JBQWtCLEdBQUcsU0FBckJBLGtCQUFxQixDQUFTQyxJQUFULEVBQWNDLEtBQWQsRUFBb0I7QUFDM0NBLEVBQUFBLEtBQUssQ0FBQ0MsVUFBTixHQUFtQkQsS0FBSyxDQUFDQyxVQUFOLElBQW9CLEVBQXZDO0FBQ0EsTUFBSUMsY0FBYyxHQUFHRixLQUFLLENBQUNDLFVBQU4sQ0FBaUJFLElBQXRDO0FBQ0Es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c0JsQjJCLE1BdEJrQixFQXNCVkssSUF0QlUsRUFzQkw7QUFDYixhQUFPQSxJQUFJLElBQUlMLE1BQWY7QUFDSCxLQXhCcUIsRUFBbkIsQ0FBUDs7QUEwQkgsQzs7OztBQUlHUixTLEdBQUFBLFMsU0FBVXdCLFMsR0FBQUEsUyxTQUFVMUQsa0IsR0FBQUEsa0IsU0FBbUI4RCxhLEdBQUFBLGEsU0FBY2xFLGtCLEdBQUFBLGtCLFNBQW1CZ0YsVyxHQUFBQSxXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAndW5kZXJzY29yZSc7XG5cbmltcG9ydCBtZDUgZnJvbSAnbWQ1JztcbmltcG9ydCBFSlNPTiBmcm9tICdlanNvbic7XG5pbXBvcnQgdm0gZnJvbSAndm0nO1xuXG5jb25zdCBlc3ByaW1hID0gcmVxdWlyZSgnZXNwcmltYScpO1xuY29uc3QgZXNjb2RlZ2VuID0gcmVxdWlyZSgnZXNjb2RlZ2VuJyk7XG5pbXBvcnQgTWFsaWJ1bkNhY2hlIGZyb20gXCIuL01hbGlidW5DYWNoZVwiO1xuaW1wb3J0IGNhY2hlZFJlZ0V4cCBmcm9tICcuL2NhY2hlZFJlZ0V4cCc7XG5cbmNvbnN0IGZiQ2FjaGUgPSBuZXcgTWFsaWJ1bkNhY2hlKCk7XG5jb25zdCBmdW5jdGlvbkdlbmVyYXRvciA9IG5ldyB2bS5TY3JpcHQoIGBuZXcgRnVuY3Rpb24oIHZtMk9wdGlvbnMuZnVuY3Rpb25Cb2R5ICk7YCApO1xuY29uc3Qgc2NyaXB0Q2FjaGUgPSBuZXcgTWFsaWJ1bkNhY2hlKCk7XG5jb25zdCByZSA9IGNhY2hlZFJlZ0V4cCgvXihbXFxzXFx0XFxuXFxyXSpyZXR1cm5bXFxzXFx0XFxuXFxyXSopPyhcXHtbXFxzXFxTXSpcXH0pKFtcXHNcXHRcXG5cXHI7XT8kKS8pO1xuXG5mdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbUhhc2goKSB7XG4gICAgcmV0dXJuIG1kNShfLnJhbmRvbSgxMDAwMDAwMDApICsgJ18nICsgXy5yYW5kb20oMTAwMDAwMDAwKSArICdfJyArIERhdGUubm93KCkpO1xufVxuXG5jb25zdCBmdW5jdGlvbkZyb21TY3JpcHQgPSBmdW5jdGlvbihleHByLHZtQ3R4KXtcbiAgICB2bUN0eC52bTJPcHRpb25zID0gdm1DdHgudm0yT3B0aW9ucyB8fCB7fTtcbiAgICBsZXQgdm0yT3B0aW9uc0hhc2ggPSB2bUN0eC52bTJPcHRpb25zLmhhc2g7XG4gICAgaWYoIXZtMk9wdGlvbnNIYXNoKXtcbiAgICAgICAgdm0yT3B0aW9uc0hhc2ggPSBnZW5lcmF0ZVJhbmRvbUhhc2goKTtcbiAgICB9XG4gICAgbGV0IGtleSA9IG1kNSggZXhwcisnOicrdm0yT3B0aW9uc0hhc2ggICk7XG4gICAgaWYocmUudGVzdChleHByKSl7XG4gICAgICAgIHJlLmxhc3RJbmRleCA9IDA7XG4gICAgICAgIGV4cHIgPSBleHByLnJlcGxhY2UocmUsKG0scHJlZml4LGJvZHksc3VmZml4KT0+e1xuICAgICAgICAgICAgaWYocHJlZml4PT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgIHByZWZpeCA9ICcnO1xuICAgICAgICAgICAgaWYoc3VmZml4PT09dW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgIHN1ZmZpeCA9ICcnO1xuICAgICAgICAgICAgcmV0dXJuIGAke3ByZWZpeH0gbmV3IE9iamVjdCgke2JvZHl9KSR7c3VmZml4fWA7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmKCFmYkNhY2hlLmhhcyhrZXkpKSB7XG4gICAgICAgIGxldCB0b2tlbnMgPSBudWxsO1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICB0b2tlbnMgPSBlc3ByaW1hLnBhcnNlU2NyaXB0KGV4cHIse3RvbGVyYW50OnRydWV9KTtcbiAgICAgICAgfWNhdGNoIChlKSB7XG4gICAgICAgICAgICB0b2tlbnMgPSBlc3ByaW1hLnBhcnNlU2NyaXB0KGAoZnVuY3Rpb24gYW5vbnltb3VzKCl7ICR7ZXhwcn0gfSkuYXBwbHkoIHRoaXMgKTtgLHt0b2xlcmFudDp0cnVlfSlcbiAgICAgICAgfVxuICAgICAgICBsZXQgbGFzdEluZGV4ID0gMDtcbiAgICAgICAgXy5lYWNoKHRva2Vucy5ib2R5LChzdGF0ZW1lbnQsaW5kZXgpPT57XG4gICAgICAgICAgICBpZiggc3RhdGVtZW50LnR5cGUhPSdFbXB0eVN0YXRlbWVudCcgKXtcbiAgICAgICAgICAgICAgICBsYXN0SW5kZXg9aW5kZXg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBsZXQgbGFzdEV4cHJlc3Npb24gPSB0b2tlbnMuYm9keVtsYXN0SW5kZXhdO1xuICAgICAgICBpZihsYXN0RXhwcmVzc2lvbikge1xuICAgICAgICAgICAgaWYoWydJZlN0YXRlbWVudCcsJ1JldHVyblN0YXRlbWVudCddLmluZGV4T2YobGFzdEV4cHJlc3Npb24udHlwZSkgPT0gLTEgKXtcbiAgICAgICAgICAgICAgICB0b2tlbnMuYm9keVt0b2tlbnMuYm9keS5sZW5ndGggLSAxXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1JldHVyblN0YXRlbWVudCcsXG4gICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50OiBsYXN0RXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IGZ1bmN0aW9uQm9keSA9IGVzY29kZWdlbi5nZW5lcmF0ZSh0b2tlbnMpO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhmdW5jdGlvbkJvZHkpO1xuXG5cbiAgICAgICAgICAgIHZtQ3R4LnZtMk9wdGlvbnMuZnVuY3Rpb25Cb2R5ID0gZnVuY3Rpb25Cb2R5O1xuICAgICAgICAgICAgbGV0IGYgPSBmdW5jdGlvbkdlbmVyYXRvci5ydW5JbkNvbnRleHQodm1DdHgpO1xuXG4gICAgICAgICAgICAvL3ZhciBmID0gbmV3IEZ1bmN0aW9uKGZ1bmN0aW9uQm9keSk7XG4gICAgICAgICAgICBmYkNhY2hlLnNldChrZXksIGYsIDUgKiA2MCAqIDEwMDApO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYkNhY2hlLmdldChrZXkpO1xufTtcblxuXG4vKipcbiAqIEByZXR1cm5zIHtPYmplY3R9IHNjb3BlXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBzY29wZS52bVxuICogQHJldHVybnMge09iamVjdH0gc2NvcGUub3JpZ2luYWxcbiAqIEBwYXJhbSB7Vk1SdW5uZXJ9IHJ1bm5lclxuICogKi9cbmZ1bmN0aW9uIHdyYXBTY29wZShzY29wZSxydW5uZXIsdm0yT3B0aW9ucyl7XG4gICAgbGV0IHNjb3BlQ29weSA9IHt9Oy8vT2JqZWN0LmFzc2lnbih7fSxzY29wZSk7XG5cbiAgICBfLmVhY2goc2NvcGUsKGluc3RhbmNlLGtleSk9PntcbiAgICAgICAgbGV0IHdyYXBwZWQgPSBudWxsO1xuICAgICAgICBpZihfLmlzT2JqZWN0KGluc3RhbmNlKSApe1xuICAgICAgICAgICAgd3JhcHBlZCA9IG5ldyBQcm94eShpbnN0YW5jZSx7XG4gICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRbcHJvcGVydHldO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcikge1xuICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdzZXQga2V5Oicsa2V5LCd2YWx1ZTonLHZhbHVlKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb3duS2V5cyh0YXJnZXQpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModGFyZ2V0KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwgbmFtZSwgcHJvcGVydHlEZXNjcmlwdG9yKXtcblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZGVsZXRlUHJvcGVydHkodGFyZ2V0LCBuYW1lKXtcblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcHJldmVudEV4dGVuc2lvbnModGFyZ2V0KXtcblxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgaGFzKHRhcmdldCwgbmFtZSl7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuYW1lIGluIHRhcmdldDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICB3cmFwcGVkID0gaW5zdGFuY2U7XG4gICAgICAgIH1cbiAgICAgICAgc2NvcGVDb3B5W2tleV0gPSB3cmFwcGVkO1xuICAgIH0pO1xuXG4gICAgc2NvcGVDb3B5LnZtMk9wdGlvbnMgPSB2bTJPcHRpb25zO1xuXG4gICAgbGV0IHZtQ29udGV4dCA9IHZtLmNyZWF0ZUNvbnRleHQoIHNjb3BlQ29weSApO1xuICAgIHJldHVybiB7XG4gICAgICAgIHZtOnZtQ29udGV4dCxcbiAgICAgICAgb3JpZ2luYWw6c2NvcGVDb3B5XG4gICAgfVxufVxuXG5mdW5jdGlvbiBnZXRTY3JpcHQoY29kZSl7XG4gICAgaWYoIV8uaXNTdHJpbmcoY29kZSl8fCFjb2RlKXtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmKCFzY3JpcHRDYWNoZS5oYXMoY29kZSkpe1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3Qgc2NyaXB0ID0gbmV3IHZtLlNjcmlwdChjb2RlKTtcbiAgICAgICAgICAgIHNjcmlwdENhY2hlLnNldChjb2RlLCBzY3JpcHQsIDUgKiA2MCAqIDEwMDApO1xuICAgICAgICB9Y2F0Y2goZSl7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2NyaXB0Q2FjaGUuZ2V0KGNvZGUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb252ZXJ0UmVzdWx0KHJlc3VsdCl7XG4gICAgbGV0IGNvbnZlcnRlZCA9IHJlc3VsdDtcbiAgICBpZihfLmlzRGF0ZShyZXN1bHQpKXtcbiAgICAgICAgY29udmVydGVkID0gbmV3IERhdGUoIHJlc3VsdC5nZXRUaW1lKCkgKTtcbiAgICB9ZWxzZSBpZihyZXN1bHQgJiYgXy5pc0Z1bmN0aW9uKHJlc3VsdC50aGVuKSl7XG4gICAgICAgIGNvbnZlcnRlZCA9IGF3YWl0IHJlc3VsdDtcbiAgICB9ZWxzZSBpZihyZXN1bHQmJnR5cGVvZiByZXN1bHQ9PSdvYmplY3QnKXtcbiAgICAgICAgY29udmVydGVkID0gRUpTT04uY2xvbmUocmVzdWx0KTtcbiAgICAgICAgZnVuY3Rpb24gY2hlY2sodGFyZ2V0LHNvdXJjZSxrZXkpe1xuICAgICAgICAgICAgbGV0IHZhbCA9IHNvdXJjZVtrZXldO1xuICAgICAgICAgICAgaWYodHlwZW9mIHZhbD09J2Z1bmN0aW9uJyl7XG4gICAgICAgICAgICAgICAgdGFyZ2V0W2tleV09dmFsO1xuICAgICAgICAgICAgfWVsc2UgaWYoXy5pc0RhdGUodmFsKSl7XG4gICAgICAgICAgICAgICAgdGFyZ2V0W2tleV0gPSBuZXcgRGF0ZSggdmFsICk7XG4gICAgICAgICAgICB9ZWxzZSBpZihfLmlzQXJyYXkodmFsKXx8Xy5pc09iamVjdCh2YWwpKXtcbiAgICAgICAgICAgICAgICBfLmVhY2goXy5rZXlzKHZhbCksKHZhbEtleSk9PntcbiAgICAgICAgICAgICAgICAgICAgY2hlY2soIHRhcmdldFtrZXldICwgdmFsLCB2YWxLZXkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIF8uZWFjaChfLmtleXMocmVzdWx0KSwoa2V5KT0+e1xuICAgICAgICAgICAgY2hlY2soY29udmVydGVkLHJlc3VsdCxrZXkpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcbn1cblxuZnVuY3Rpb24gd3JhcEluUHJveHkoaW5zdGFuY2Upe1xuICAgIHJldHVybiBuZXcgUHJveHkoaW5zdGFuY2Use1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uKHRhcmdldCwgcHJvcGVydHkpIHtcbiAgICAgICAgICAgIHJldHVybiB0YXJnZXRbcHJvcGVydHldO1xuICAgICAgICB9LFxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh0YXJnZXQsIGtleSwgdmFsdWUsIHJlY2VpdmVyKSB7XG5cbiAgICAgICAgfSxcbiAgICAgICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgbmFtZSl7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpO1xuICAgICAgICB9LFxuICAgICAgICBvd25LZXlzKHRhcmdldCl7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModGFyZ2V0KTtcbiAgICAgICAgfSxcbiAgICAgICAgZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBuYW1lLCBwcm9wZXJ0eURlc2NyaXB0b3Ipe1xuXG4gICAgICAgIH0sXG4gICAgICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwgbmFtZSl7XG5cbiAgICAgICAgfSxcbiAgICAgICAgcHJldmVudEV4dGVuc2lvbnModGFyZ2V0KXtcblxuICAgICAgICB9LFxuICAgICAgICBoYXModGFyZ2V0LCBuYW1lKXtcbiAgICAgICAgICAgIHJldHVybiBuYW1lIGluIHRhcmdldDtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5cbmV4cG9ydCB7XG4gICAgd3JhcFNjb3BlLGdldFNjcmlwdCxmdW5jdGlvbkZyb21TY3JpcHQsY29udmVydFJlc3VsdCxnZW5lcmF0ZVJhbmRvbUhhc2gsd3JhcEluUHJveHlcbn1cblxuIl19