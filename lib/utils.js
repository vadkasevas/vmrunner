"use strict";var _interopRequireDefault3 = require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireDefault2 = _interopRequireDefault3(require("@babel/runtime/helpers/interopRequireDefault"));Object.defineProperty(exports, "__esModule", { value: true });exports.wrapInProxy = exports.generateRandomHash = exports.convertResult = exports.functionFromScript = exports.getScript = exports.wrapScope = undefined;var _regenerator = require("@babel/runtime/regenerator");var _regeneratorRuntime = (0, _interopRequireDefault2["default"])(_regenerator)["default"];var _typeof2 = require("@babel/runtime/helpers/typeof");var _typeof = (0, _interopRequireDefault2["default"])(_typeof2)["default"];var _underscore = require("underscore");var _ = (0, _interopRequireDefault2["default"])(_underscore)["default"];

var _md = require("md5");var md5 = (0, _interopRequireDefault2["default"])(_md)["default"];
var _ejson = require("ejson");var EJSON = (0, _interopRequireDefault2["default"])(_ejson)["default"];
var _vm = require("vm");var vm = (0, _interopRequireDefault2["default"])(_vm)["default"];



var _MalibunCache = require("./MalibunCache");var MalibunCache = (0, _interopRequireDefault2["default"])(_MalibunCache)["default"];var esprima = require('esprima');var escodegen = require('escodegen');
var fbCache = new MalibunCache();
var functionGenerator = new vm.Script("new Function( vm2Options.functionBody );");
var scriptCache = new MalibunCache();

function generateRandomHash() {
  return md5(_.random(100000000) + '_' + _.random(100000000) + '_' + Date.now());
}

var functionFromScript = function functionFromScript(expr, vmCtx) {
  vmCtx.vm2Options = vmCtx.vm2Options || {};
  var vm2OptionsHash = vmCtx.vm2Options.hash;
  if (!vm2OptionsHash) {
    vm2OptionsHash = generateRandomHash();
  }
  var key = md5(expr + ':' + vm2OptionsHash);
  if (!fbCache.has(key)) {
    var tokens = null;
    try {
      tokens = esprima.parseScript(expr, { tolerant: true });
    } catch (e) {
      tokens = esprima.parseScript("\n                (function anonymous(){\n                    ".concat(

      expr, "\n                }).apply( this );\n            "),

      { tolerant: true });
    }
    var lastIndex = 0;
    _.each(tokens.body, function (statement, index) {
      if (statement.type != 'EmptyStatement') {
        lastIndex = index;
      }
    });
    var lastExpression = tokens.body[lastIndex];
    if (lastExpression) {
      if (['IfStatement', 'ReturnStatement'].indexOf(lastExpression.type) == -1) {
        tokens.body[tokens.body.length - 1] = {
          type: 'ReturnStatement',
          argument: lastExpression };

      }
      var functionBody = escodegen.generate(tokens);
      //console.log(functionBody);


      vmCtx.vm2Options.functionBody = functionBody;
      var f = functionGenerator.runInContext(vmCtx);

      //var f = new Function(functionBody);
      fbCache.set(key, f, 5 * 60 * 1000);
    }
  }
  return fbCache.get(key);
};


/**
    * @returns {Object} scope
    * @returns {Object} scope.vm
    * @returns {Object} scope.original
    * @param {VMRunner} runner
    * */
function wrapScope(scope, runner, vm2Options) {
  var scopeCopy = {}; //Object.assign({},scope);

  _.each(scope, function (instance, key) {
    var wrapped = null;
    if (_.isObject(instance)) {
      wrapped = new Proxy(instance, {
        get: function get(target, property) {
          return target[property];
        },
        set: function set(target, key, value, receiver) {
          //console.log('set key:',key,'value:',value);
        },
        getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
          return Object.getOwnPropertyDescriptor(target, name);
        },
        ownKeys: function ownKeys(target) {
          return Object.getOwnPropertyNames(target);
        },
        defineProperty: function defineProperty(target, name, propertyDescriptor) {

        },
        deleteProperty: function deleteProperty(target, name) {

        },
        preventExtensions: function preventExtensions(target) {

        },
        has: function has(target, name) {
          return name in target;
        } });

    } else {
      wrapped = instance;
    }
    scopeCopy[key] = wrapped;
  });

  scopeCopy.vm2Options = vm2Options;

  var vmContext = vm.createContext(scopeCopy);
  return {
    vm: vmContext,
    original: scopeCopy };

}

function getScript(code) {
  if (!_.isString(code) || !code) {
    return null;
  }
  if (!scriptCache.has(code)) {
    try {
      var script = new vm.Script(code);
      scriptCache.set(code, script, 5 * 60 * 1000);
    } catch (e) {
      return null;
    }
  }
  return scriptCache.get(code);
}

function convertResult(result) {var converted, check;return _regeneratorRuntime.async(function convertResult$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
          converted = result;if (!
          _.isDate(result)) {_context.next = 5;break;}
          converted = new Date(result.getTime());_context.next = 12;break;case 5:if (!(
          result && _.isFunction(result.then))) {_context.next = 11;break;}_context.next = 8;return _regeneratorRuntime.awrap(
          result);case 8:converted = _context.sent;_context.next = 12;break;case 11:
          if (result && _typeof(result) == 'object') {

            check = function check(target, source, key) {
              var val = source[key];
              if (typeof val == 'function') {
                target[key] = val;
              } else if (_.isDate(val)) {
                target[key] = new Date(val);
              } else if (_.isArray(val) || _.isObject(val)) {
                _.each(_.keys(val), function (valKey) {
                  check(target[key], val, valKey);
                });
              }
            };converted = EJSON.clone(result);
            _.each(_.keys(result), function (key) {
              check(converted, result, key);
            });
          }case 12:return _context.abrupt("return",
          converted);case 13:case "end":return _context.stop();}}});}


function wrapInProxy(instance) {
  return new Proxy(instance, {
    get: function get(target, property) {
      return target[property];
    },
    set: function set(target, key, value, receiver) {

    },
    getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
      return Object.getOwnPropertyDescriptor(target, name);
    },
    ownKeys: function ownKeys(target) {
      return Object.getOwnPropertyNames(target);
    },
    defineProperty: function defineProperty(target, name, propertyDescriptor) {

    },
    deleteProperty: function deleteProperty(target, name) {

    },
    preventExtensions: function preventExtensions(target) {

    },
    has: function has(target, name) {
      return name in target;
    } });

}exports.



wrapScope = wrapScope;exports.getScript = getScript;exports.functionFromScript = functionFromScript;exports.convertResult = convertResult;exports.generateRandomHash = generateRandomHash;exports.wrapInProxy = wrapInProxy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJfIiwibWQ1IiwiRUpTT04iLCJ2bSIsIk1hbGlidW5DYWNoZSIsImVzcHJpbWEiLCJyZXF1aXJlIiwiZXNjb2RlZ2VuIiwiZmJDYWNoZSIsImZ1bmN0aW9uR2VuZXJhdG9yIiwiU2NyaXB0Iiwic2NyaXB0Q2FjaGUiLCJnZW5lcmF0ZVJhbmRvbUhhc2giLCJyYW5kb20iLCJEYXRlIiwibm93IiwiZnVuY3Rpb25Gcm9tU2NyaXB0IiwiZXhwciIsInZtQ3R4Iiwidm0yT3B0aW9ucyIsInZtMk9wdGlvbnNIYXNoIiwiaGFzaCIsImtleSIsImhhcyIsInRva2VucyIsInBhcnNlU2NyaXB0IiwidG9sZXJhbnQiLCJlIiwibGFzdEluZGV4IiwiZWFjaCIsImJvZHkiLCJzdGF0ZW1lbnQiLCJpbmRleCIsInR5cGUiLCJsYXN0RXhwcmVzc2lvbiIsImluZGV4T2YiLCJsZW5ndGgiLCJhcmd1bWVudCIsImZ1bmN0aW9uQm9keSIsImdlbmVyYXRlIiwiZiIsInJ1bkluQ29udGV4dCIsInNldCIsImdldCIsIndyYXBTY29wZSIsInNjb3BlIiwicnVubmVyIiwic2NvcGVDb3B5IiwiaW5zdGFuY2UiLCJ3cmFwcGVkIiwiaXNPYmplY3QiLCJQcm94eSIsInRhcmdldCIsInByb3BlcnR5IiwidmFsdWUiLCJyZWNlaXZlciIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsIm5hbWUiLCJPYmplY3QiLCJvd25LZXlzIiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImRlZmluZVByb3BlcnR5IiwicHJvcGVydHlEZXNjcmlwdG9yIiwiZGVsZXRlUHJvcGVydHkiLCJwcmV2ZW50RXh0ZW5zaW9ucyIsInZtQ29udGV4dCIsImNyZWF0ZUNvbnRleHQiLCJvcmlnaW5hbCIsImdldFNjcmlwdCIsImNvZGUiLCJpc1N0cmluZyIsInNjcmlwdCIsImNvbnZlcnRSZXN1bHQiLCJyZXN1bHQiLCJjb252ZXJ0ZWQiLCJpc0RhdGUiLCJnZXRUaW1lIiwiaXNGdW5jdGlvbiIsInRoZW4iLCJjaGVjayIsInNvdXJjZSIsInZhbCIsImlzQXJyYXkiLCJrZXlzIiwidmFsS2V5IiwiY2xvbmUiLCJ3cmFwSW5Qcm94eSJdLCJtYXBwaW5ncyI6ImlzQkFBQSx3QyxJQUFPQSxDOztBQUVQLHlCLElBQU9DLEc7QUFDUCw4QixJQUFPQyxLO0FBQ1Asd0IsSUFBT0MsRTs7OztBQUlQLDhDLElBQU9DLFkscUVBRlAsSUFBTUMsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2QixDQUNBLElBQU1DLFNBQVMsR0FBR0QsT0FBTyxDQUFDLFdBQUQsQ0FBekI7QUFFQSxJQUFNRSxPQUFPLEdBQUcsSUFBSUosWUFBSixFQUFoQjtBQUNBLElBQU1LLGlCQUFpQixHQUFHLElBQUlOLEVBQUUsQ0FBQ08sTUFBUCw0Q0FBMUI7QUFDQSxJQUFNQyxXQUFXLEdBQUcsSUFBSVAsWUFBSixFQUFwQjs7QUFFQSxTQUFTUSxrQkFBVCxHQUE4QjtBQUMxQixTQUFPWCxHQUFHLENBQUNELENBQUMsQ0FBQ2EsTUFBRixDQUFTLFNBQVQsSUFBc0IsR0FBdEIsR0FBNEJiLENBQUMsQ0FBQ2EsTUFBRixDQUFTLFNBQVQsQ0FBNUIsR0FBa0QsR0FBbEQsR0FBd0RDLElBQUksQ0FBQ0MsR0FBTCxFQUF6RCxDQUFWO0FBQ0g7O0FBRUQsSUFBTUMsa0JBQWtCLEdBQUcsU0FBckJBLGtCQUFxQixDQUFTQyxJQUFULEVBQWNDLEtBQWQsRUFBb0I7QUFDM0NBLEVBQUFBLEtBQUssQ0FBQ0MsVUFBTixHQUFtQkQsS0FBSyxDQUFDQyxVQUFOLElBQW9CLEVBQXZDO0FBQ0EsTUFBSUMsY0FBYyxHQUFHRixLQUFLLENBQUNDLFVBQU4sQ0FBaUJFLElBQXRDO0FBQ0EsTUFBRyxDQUFDRCxjQUFKLEVBQW1CO0FBQ2ZBLElBQUFBLGNBQWMsR0FBR1Isa0JBQWtCLEVBQW5DO0FBQ0g7QUFDRCxNQUFJVSxHQUFHLEdBQUdyQixHQUFHLENBQUVnQixJQUFJLEdBQUMsR0FBTCxHQUFTRyxjQUFYLENBQWI7QUFD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SUFQWCxFQU9nQjtBQUNsQyxhQUFPQyxNQUFNLENBQUNGLHdCQUFQLENBQWdDSixNQUFoQyxFQUF3Q0ssSUFBeEMsQ0FBUDtBQUNILEtBVHFCO0FBVXRCRSxJQUFBQSxPQVZzQixtQkFVZFAsTUFWYyxFQVVQO0FBQ1gsYUFBT00sTUFBTSxDQUFDRSxtQkFBUCxDQUEyQlIsTUFBM0IsQ0FBUDtBQUNILEtBWnFCO0FBYXRCUyxJQUFBQSxjQWJzQiwwQkFhUFQsTUFiTyxFQWFDSyxJQWJELEVBYU9LLGtCQWJQLEVBYTBCOztBQUUvQyxLQWZxQjtBQWdCdEJDLElBQUFBLGNBaEJzQiwwQkFnQlBYLE1BaEJPLEVBZ0JDSyxJQWhCRCxFQWdCTTs7QUFFM0IsS0FsQnFCO0FBbUJ0Qk8sSUFBQUEsaUJBbkJzQiw2QkFtQkpaLE1BbkJJLEVBbUJHOztBQUV4QixLQXJCcUI7QUFzQnRCN0IsSUFBQUEsR0F0QnNCLGVBc0JsQjZCLE1BdEJrQixFQXNCVkssSUF0QlUsRUFzQkw7QUFDYixhQUFPQSxJQUFJLElBQUlMLE1BQWY7QUFDSCxLQXhCcUIsRUFBbkIsQ0FBUDs7QUEwQkgsQzs7OztBQUlHUixTLEdBQUFBLFMsU0FBVXdCLFMsR0FBQUEsUyxTQUFVcEQsa0IsR0FBQUEsa0IsU0FBbUJ3RCxhLEdBQUFBLGEsU0FBYzVELGtCLEdBQUFBLGtCLFNBQW1CMEUsVyxHQUFBQSxXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAndW5kZXJzY29yZSc7XG5cbmltcG9ydCBtZDUgZnJvbSAnbWQ1JztcbmltcG9ydCBFSlNPTiBmcm9tICdlanNvbic7XG5pbXBvcnQgdm0gZnJvbSAndm0nO1xuXG5jb25zdCBlc3ByaW1hID0gcmVxdWlyZSgnZXNwcmltYScpO1xuY29uc3QgZXNjb2RlZ2VuID0gcmVxdWlyZSgnZXNjb2RlZ2VuJyk7XG5pbXBvcnQgTWFsaWJ1bkNhY2hlIGZyb20gXCIuL01hbGlidW5DYWNoZVwiO1xuY29uc3QgZmJDYWNoZSA9IG5ldyBNYWxpYnVuQ2FjaGUoKTtcbmNvbnN0IGZ1bmN0aW9uR2VuZXJhdG9yID0gbmV3IHZtLlNjcmlwdCggYG5ldyBGdW5jdGlvbiggdm0yT3B0aW9ucy5mdW5jdGlvbkJvZHkgKTtgICk7XG5jb25zdCBzY3JpcHRDYWNoZSA9IG5ldyBNYWxpYnVuQ2FjaGUoKTtcblxuZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21IYXNoKCkge1xuICAgIHJldHVybiBtZDUoXy5yYW5kb20oMTAwMDAwMDAwKSArICdfJyArIF8ucmFuZG9tKDEwMDAwMDAwMCkgKyAnXycgKyBEYXRlLm5vdygpKTtcbn1cblxuY29uc3QgZnVuY3Rpb25Gcm9tU2NyaXB0ID0gZnVuY3Rpb24oZXhwcix2bUN0eCl7XG4gICAgdm1DdHgudm0yT3B0aW9ucyA9IHZtQ3R4LnZtMk9wdGlvbnMgfHwge307XG4gICAgbGV0IHZtMk9wdGlvbnNIYXNoID0gdm1DdHgudm0yT3B0aW9ucy5oYXNoO1xuICAgIGlmKCF2bTJPcHRpb25zSGFzaCl7XG4gICAgICAgIHZtMk9wdGlvbnNIYXNoID0gZ2VuZXJhdGVSYW5kb21IYXNoKCk7XG4gICAgfVxuICAgIGxldCBrZXkgPSBtZDUoIGV4cHIrJzonK3ZtMk9wdGlvbnNIYXNoICApO1xuICAgIGlmKCFmYkNhY2hlLmhhcyhrZXkpKSB7XG4gICAgICAgIGxldCB0b2tlbnMgPSBudWxsO1xuICAgICAgICB0cnl7XG4gICAgICAgICAgICB0b2tlbnMgPSBlc3ByaW1hLnBhcnNlU2NyaXB0KGV4cHIse3RvbGVyYW50OnRydWV9KTtcbiAgICAgICAgfWNhdGNoIChlKSB7XG4gICAgICAgICAgICB0b2tlbnMgPSBlc3ByaW1hLnBhcnNlU2NyaXB0KGBcbiAgICAgICAgICAgICAgICAoZnVuY3Rpb24gYW5vbnltb3VzKCl7XG4gICAgICAgICAgICAgICAgICAgICR7ZXhwcn1cbiAgICAgICAgICAgICAgICB9KS5hcHBseSggdGhpcyApO1xuICAgICAgICAgICAgYCx7dG9sZXJhbnQ6dHJ1ZX0pXG4gICAgICAgIH1cbiAgICAgICAgbGV0IGxhc3RJbmRleCA9IDA7XG4gICAgICAgIF8uZWFjaCh0b2tlbnMuYm9keSwoc3RhdGVtZW50LGluZGV4KT0+e1xuICAgICAgICAgICAgaWYoIHN0YXRlbWVudC50eXBlIT0nRW1wdHlTdGF0ZW1lbnQnICl7XG4gICAgICAgICAgICAgICAgbGFzdEluZGV4PWluZGV4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgbGV0IGxhc3RFeHByZXNzaW9uID0gdG9rZW5zLmJvZHlbbGFzdEluZGV4XTtcbiAgICAgICAgaWYobGFzdEV4cHJlc3Npb24pIHtcbiAgICAgICAgICAgIGlmKFsnSWZTdGF0ZW1lbnQnLCdSZXR1cm5TdGF0ZW1lbnQnXS5pbmRleE9mKGxhc3RFeHByZXNzaW9uLnR5cGUpID09IC0xICl7XG4gICAgICAgICAgICAgICAgdG9rZW5zLmJvZHlbdG9rZW5zLmJvZHkubGVuZ3RoIC0gMV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdSZXR1cm5TdGF0ZW1lbnQnLFxuICAgICAgICAgICAgICAgICAgICBhcmd1bWVudDogbGFzdEV4cHJlc3Npb24sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBmdW5jdGlvbkJvZHkgPSBlc2NvZGVnZW4uZ2VuZXJhdGUodG9rZW5zKTtcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coZnVuY3Rpb25Cb2R5KTtcblxuXG4gICAgICAgICAgICB2bUN0eC52bTJPcHRpb25zLmZ1bmN0aW9uQm9keSA9IGZ1bmN0aW9uQm9keTtcbiAgICAgICAgICAgIGxldCBmID0gZnVuY3Rpb25HZW5lcmF0b3IucnVuSW5Db250ZXh0KHZtQ3R4KTtcblxuICAgICAgICAgICAgLy92YXIgZiA9IG5ldyBGdW5jdGlvbihmdW5jdGlvbkJvZHkpO1xuICAgICAgICAgICAgZmJDYWNoZS5zZXQoa2V5LCBmLCA1ICogNjAgKiAxMDAwKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmJDYWNoZS5nZXQoa2V5KTtcbn07XG5cblxuLyoqXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBzY29wZVxuICogQHJldHVybnMge09iamVjdH0gc2NvcGUudm1cbiAqIEByZXR1cm5zIHtPYmplY3R9IHNjb3BlLm9yaWdpbmFsXG4gKiBAcGFyYW0ge1ZNUnVubmVyfSBydW5uZXJcbiAqICovXG5mdW5jdGlvbiB3cmFwU2NvcGUoc2NvcGUscnVubmVyLHZtMk9wdGlvbnMpe1xuICAgIGxldCBzY29wZUNvcHkgPSB7fTsvL09iamVjdC5hc3NpZ24oe30sc2NvcGUpO1xuXG4gICAgXy5lYWNoKHNjb3BlLChpbnN0YW5jZSxrZXkpPT57XG4gICAgICAgIGxldCB3cmFwcGVkID0gbnVsbDtcbiAgICAgICAgaWYoXy5pc09iamVjdChpbnN0YW5jZSkgKXtcbiAgICAgICAgICAgIHdyYXBwZWQgPSBuZXcgUHJveHkoaW5zdGFuY2Use1xuICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24odGFyZ2V0LCBwcm9wZXJ0eSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BlcnR5XTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnc2V0IGtleTonLGtleSwndmFsdWU6Jyx2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG93bktleXModGFyZ2V0KXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRhcmdldCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIG5hbWUsIHByb3BlcnR5RGVzY3JpcHRvcil7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwgbmFtZSl7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHByZXZlbnRFeHRlbnNpb25zKHRhcmdldCl7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGhhcyh0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmFtZSBpbiB0YXJnZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgd3JhcHBlZCA9IGluc3RhbmNlO1xuICAgICAgICB9XG4gICAgICAgIHNjb3BlQ29weVtrZXldID0gd3JhcHBlZDtcbiAgICB9KTtcblxuICAgIHNjb3BlQ29weS52bTJPcHRpb25zID0gdm0yT3B0aW9ucztcblxuICAgIGxldCB2bUNvbnRleHQgPSB2bS5jcmVhdGVDb250ZXh0KCBzY29wZUNvcHkgKTtcbiAgICByZXR1cm4ge1xuICAgICAgICB2bTp2bUNvbnRleHQsXG4gICAgICAgIG9yaWdpbmFsOnNjb3BlQ29weVxuICAgIH1cbn1cblxuZnVuY3Rpb24gZ2V0U2NyaXB0KGNvZGUpe1xuICAgIGlmKCFfLmlzU3RyaW5nKGNvZGUpfHwhY29kZSl7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBpZighc2NyaXB0Q2FjaGUuaGFzKGNvZGUpKXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNjcmlwdCA9IG5ldyB2bS5TY3JpcHQoY29kZSk7XG4gICAgICAgICAgICBzY3JpcHRDYWNoZS5zZXQoY29kZSwgc2NyaXB0LCA1ICogNjAgKiAxMDAwKTtcbiAgICAgICAgfWNhdGNoKGUpe1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNjcmlwdENhY2hlLmdldChjb2RlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29udmVydFJlc3VsdChyZXN1bHQpe1xuICAgIGxldCBjb252ZXJ0ZWQgPSByZXN1bHQ7XG4gICAgaWYoXy5pc0RhdGUocmVzdWx0KSl7XG4gICAgICAgIGNvbnZlcnRlZCA9IG5ldyBEYXRlKCByZXN1bHQuZ2V0VGltZSgpICk7XG4gICAgfWVsc2UgaWYocmVzdWx0ICYmIF8uaXNGdW5jdGlvbihyZXN1bHQudGhlbikpe1xuICAgICAgICBjb252ZXJ0ZWQgPSBhd2FpdCByZXN1bHQ7XG4gICAgfWVsc2UgaWYocmVzdWx0JiZ0eXBlb2YgcmVzdWx0PT0nb2JqZWN0Jyl7XG4gICAgICAgIGNvbnZlcnRlZCA9IEVKU09OLmNsb25lKHJlc3VsdCk7XG4gICAgICAgIGZ1bmN0aW9uIGNoZWNrKHRhcmdldCxzb3VyY2Usa2V5KXtcbiAgICAgICAgICAgIGxldCB2YWwgPSBzb3VyY2Vba2V5XTtcbiAgICAgICAgICAgIGlmKHR5cGVvZiB2YWw9PSdmdW5jdGlvbicpe1xuICAgICAgICAgICAgICAgIHRhcmdldFtrZXldPXZhbDtcbiAgICAgICAgICAgIH1lbHNlIGlmKF8uaXNEYXRlKHZhbCkpe1xuICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gbmV3IERhdGUoIHZhbCApO1xuICAgICAgICAgICAgfWVsc2UgaWYoXy5pc0FycmF5KHZhbCl8fF8uaXNPYmplY3QodmFsKSl7XG4gICAgICAgICAgICAgICAgXy5lYWNoKF8ua2V5cyh2YWwpLCh2YWxLZXkpPT57XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrKCB0YXJnZXRba2V5XSAsIHZhbCwgdmFsS2V5KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBfLmVhY2goXy5rZXlzKHJlc3VsdCksKGtleSk9PntcbiAgICAgICAgICAgIGNoZWNrKGNvbnZlcnRlZCxyZXN1bHQsa2V5KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjb252ZXJ0ZWQ7XG59XG5cbmZ1bmN0aW9uIHdyYXBJblByb3h5KGluc3RhbmNlKXtcbiAgICByZXR1cm4gbmV3IFByb3h5KGluc3RhbmNlLHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5KSB7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BlcnR5XTtcbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcikge1xuXG4gICAgICAgIH0sXG4gICAgICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgICAgfSxcbiAgICAgICAgb3duS2V5cyh0YXJnZXQpe1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRhcmdldCk7XG4gICAgICAgIH0sXG4gICAgICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwgbmFtZSwgcHJvcGVydHlEZXNjcmlwdG9yKXtcblxuICAgICAgICB9LFxuICAgICAgICBkZWxldGVQcm9wZXJ0eSh0YXJnZXQsIG5hbWUpe1xuXG4gICAgICAgIH0sXG4gICAgICAgIHByZXZlbnRFeHRlbnNpb25zKHRhcmdldCl7XG5cbiAgICAgICAgfSxcbiAgICAgICAgaGFzKHRhcmdldCwgbmFtZSl7XG4gICAgICAgICAgICByZXR1cm4gbmFtZSBpbiB0YXJnZXQ7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuXG5leHBvcnQge1xuICAgIHdyYXBTY29wZSxnZXRTY3JpcHQsZnVuY3Rpb25Gcm9tU2NyaXB0LGNvbnZlcnRSZXN1bHQsZ2VuZXJhdGVSYW5kb21IYXNoLHdyYXBJblByb3h5XG59XG5cbiJdfQ==