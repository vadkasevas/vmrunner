"use strict";var _interopRequireDefault3 = require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireDefault2 = _interopRequireDefault3(require("@babel/runtime/helpers/interopRequireDefault"));Object.defineProperty(exports, "__esModule", { value: true });exports.wrapInProxy = exports.generateRandomHash = exports.convertResult = exports.functionFromScript = exports.getScript = exports.wrapScope = undefined;var _regenerator = require("@babel/runtime/regenerator");var _regeneratorRuntime = (0, _interopRequireDefault2["default"])(_regenerator)["default"];var _typeof2 = require("@babel/runtime/helpers/typeof");var _typeof = (0, _interopRequireDefault2["default"])(_typeof2)["default"];var _underscore = require("underscore");var _ = (0, _interopRequireDefault2["default"])(_underscore)["default"];

var _md = require("md5");var md5 = (0, _interopRequireDefault2["default"])(_md)["default"];
var _ejson = require("ejson");var EJSON = (0, _interopRequireDefault2["default"])(_ejson)["default"];
var _vm = require("vm");var vm = (0, _interopRequireDefault2["default"])(_vm)["default"];



var _MalibunCache = require("./MalibunCache");var MalibunCache = (0, _interopRequireDefault2["default"])(_MalibunCache)["default"];var esprima = require('esprima');var escodegen = require('escodegen');
var fbCache = new MalibunCache();
var functionGenerator = new vm.Script("new Function( vm2Options.functionBody );");
var scriptCache = new MalibunCache();

function generateRandomHash() {
  return md5(_.random(100000000) + '_' + _.random(100000000) + '_' + Date.now());
}

var functionFromScript = function functionFromScript(expr, vmCtx) {
  vmCtx.vm2Options = vmCtx.vm2Options || {};
  var vm2OptionsHash = vmCtx.vm2Options.hash;
  if (!vm2OptionsHash) {
    vm2OptionsHash = generateRandomHash();
  }
  var key = md5(expr + ':' + vm2OptionsHash);
  if (!fbCache.has(key)) {
    var tokens = null;
    try {
      tokens = esprima.parseScript(expr, { tolerant: true });
    } catch (e) {
      tokens = esprima.parseScript("(function anonymous(){ ".concat(expr, " }).apply( this );"), { tolerant: true });
    }
    var lastIndex = 0;
    _.each(tokens.body, function (statement, index) {
      if (statement.type != 'EmptyStatement') {
        lastIndex = index;
      }
    });
    var lastExpression = tokens.body[lastIndex];
    if (lastExpression) {
      if (['IfStatement', 'ReturnStatement'].indexOf(lastExpression.type) == -1) {
        tokens.body[tokens.body.length - 1] = {
          type: 'ReturnStatement',
          argument: lastExpression };

      }
      var functionBody = escodegen.generate(tokens);
      //console.log(functionBody);


      vmCtx.vm2Options.functionBody = functionBody;
      var f = functionGenerator.runInContext(vmCtx);

      //var f = new Function(functionBody);
      fbCache.set(key, f, 5 * 60 * 1000);
    }
  }
  return fbCache.get(key);
};


/**
    * @returns {Object} scope
    * @returns {Object} scope.vm
    * @returns {Object} scope.original
    * @param {VMRunner} runner
    * */
function wrapScope(scope, runner, vm2Options) {
  var scopeCopy = {}; //Object.assign({},scope);

  _.each(scope, function (instance, key) {
    var wrapped = null;
    if (_.isObject(instance)) {
      wrapped = new Proxy(instance, {
        get: function get(target, property) {
          return target[property];
        },
        set: function set(target, key, value, receiver) {
          //console.log('set key:',key,'value:',value);
        },
        getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
          return Object.getOwnPropertyDescriptor(target, name);
        },
        ownKeys: function ownKeys(target) {
          return Object.getOwnPropertyNames(target);
        },
        defineProperty: function defineProperty(target, name, propertyDescriptor) {

        },
        deleteProperty: function deleteProperty(target, name) {

        },
        preventExtensions: function preventExtensions(target) {

        },
        has: function has(target, name) {
          return name in target;
        } });

    } else {
      wrapped = instance;
    }
    scopeCopy[key] = wrapped;
  });

  scopeCopy.vm2Options = vm2Options;

  var vmContext = vm.createContext(scopeCopy);
  return {
    vm: vmContext,
    original: scopeCopy };

}

function getScript(code) {
  if (!_.isString(code) || !code) {
    return null;
  }
  if (!scriptCache.has(code)) {
    try {
      var script = new vm.Script(code);
      scriptCache.set(code, script, 5 * 60 * 1000);
    } catch (e) {
      return null;
    }
  }
  return scriptCache.get(code);
}

function convertResult(result) {var converted, check;return _regeneratorRuntime.async(function convertResult$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
          converted = result;if (!
          _.isDate(result)) {_context.next = 5;break;}
          converted = new Date(result.getTime());_context.next = 12;break;case 5:if (!(
          result && _.isFunction(result.then))) {_context.next = 11;break;}_context.next = 8;return _regeneratorRuntime.awrap(
          result);case 8:converted = _context.sent;_context.next = 12;break;case 11:
          if (result && _typeof(result) == 'object') {

            check = function check(target, source, key) {
              var val = source[key];
              if (typeof val == 'function') {
                target[key] = val;
              } else if (_.isDate(val)) {
                target[key] = new Date(val);
              } else if (_.isArray(val) || _.isObject(val)) {
                _.each(_.keys(val), function (valKey) {
                  check(target[key], val, valKey);
                });
              }
            };converted = EJSON.clone(result);
            _.each(_.keys(result), function (key) {
              check(converted, result, key);
            });
          }case 12:return _context.abrupt("return",
          converted);case 13:case "end":return _context.stop();}}});}


function wrapInProxy(instance) {
  return new Proxy(instance, {
    get: function get(target, property) {
      return target[property];
    },
    set: function set(target, key, value, receiver) {

    },
    getOwnPropertyDescriptor: function getOwnPropertyDescriptor(target, name) {
      return Object.getOwnPropertyDescriptor(target, name);
    },
    ownKeys: function ownKeys(target) {
      return Object.getOwnPropertyNames(target);
    },
    defineProperty: function defineProperty(target, name, propertyDescriptor) {

    },
    deleteProperty: function deleteProperty(target, name) {

    },
    preventExtensions: function preventExtensions(target) {

    },
    has: function has(target, name) {
      return name in target;
    } });

}exports.



wrapScope = wrapScope;exports.getScript = getScript;exports.functionFromScript = functionFromScript;exports.convertResult = convertResult;exports.generateRandomHash = generateRandomHash;exports.wrapInProxy = wrapInProxy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy91dGlscy5qcyJdLCJuYW1lcyI6WyJfIiwibWQ1IiwiRUpTT04iLCJ2bSIsIk1hbGlidW5DYWNoZSIsImVzcHJpbWEiLCJyZXF1aXJlIiwiZXNjb2RlZ2VuIiwiZmJDYWNoZSIsImZ1bmN0aW9uR2VuZXJhdG9yIiwiU2NyaXB0Iiwic2NyaXB0Q2FjaGUiLCJnZW5lcmF0ZVJhbmRvbUhhc2giLCJyYW5kb20iLCJEYXRlIiwibm93IiwiZnVuY3Rpb25Gcm9tU2NyaXB0IiwiZXhwciIsInZtQ3R4Iiwidm0yT3B0aW9ucyIsInZtMk9wdGlvbnNIYXNoIiwiaGFzaCIsImtleSIsImhhcyIsInRva2VucyIsInBhcnNlU2NyaXB0IiwidG9sZXJhbnQiLCJlIiwibGFzdEluZGV4IiwiZWFjaCIsImJvZHkiLCJzdGF0ZW1lbnQiLCJpbmRleCIsInR5cGUiLCJsYXN0RXhwcmVzc2lvbiIsImluZGV4T2YiLCJsZW5ndGgiLCJhcmd1bWVudCIsImZ1bmN0aW9uQm9keSIsImdlbmVyYXRlIiwiZiIsInJ1bkluQ29udGV4dCIsInNldCIsImdldCIsIndyYXBTY29wZSIsInNjb3BlIiwicnVubmVyIiwic2NvcGVDb3B5IiwiaW5zdGFuY2UiLCJ3cmFwcGVkIiwiaXNPYmplY3QiLCJQcm94eSIsInRhcmdldCIsInByb3BlcnR5IiwidmFsdWUiLCJyZWNlaXZlciIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsIm5hbWUiLCJPYmplY3QiLCJvd25LZXlzIiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImRlZmluZVByb3BlcnR5IiwicHJvcGVydHlEZXNjcmlwdG9yIiwiZGVsZXRlUHJvcGVydHkiLCJwcmV2ZW50RXh0ZW5zaW9ucyIsInZtQ29udGV4dCIsImNyZWF0ZUNvbnRleHQiLCJvcmlnaW5hbCIsImdldFNjcmlwdCIsImNvZGUiLCJpc1N0cmluZyIsInNjcmlwdCIsImNvbnZlcnRSZXN1bHQiLCJyZXN1bHQiLCJjb252ZXJ0ZWQiLCJpc0RhdGUiLCJnZXRUaW1lIiwiaXNGdW5jdGlvbiIsInRoZW4iLCJjaGVjayIsInNvdXJjZSIsInZhbCIsImlzQXJyYXkiLCJrZXlzIiwidmFsS2V5IiwiY2xvbmUiLCJ3cmFwSW5Qcm94eSJdLCJtYXBwaW5ncyI6ImlzQkFBQSx3QyxJQUFPQSxDOztBQUVQLHlCLElBQU9DLEc7QUFDUCw4QixJQUFPQyxLO0FBQ1Asd0IsSUFBT0MsRTs7OztBQUlQLDhDLElBQU9DLFkscUVBRlAsSUFBTUMsT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2QixDQUNBLElBQU1DLFNBQVMsR0FBR0QsT0FBTyxDQUFDLFdBQUQsQ0FBekI7QUFFQSxJQUFNRSxPQUFPLEdBQUcsSUFBSUosWUFBSixFQUFoQjtBQUNBLElBQU1LLGlCQUFpQixHQUFHLElBQUlOLEVBQUUsQ0FBQ08sTUFBUCw0Q0FBMUI7QUFDQSxJQUFNQyxXQUFXLEdBQUcsSUFBSVAsWUFBSixFQUFwQjs7QUFFQSxTQUFTUSxrQkFBVCxHQUE4QjtBQUMxQixTQUFPWCxHQUFHLENBQUNELENBQUMsQ0FBQ2EsTUFBRixDQUFTLFNBQVQsSUFBc0IsR0FBdEIsR0FBNEJiLENBQUMsQ0FBQ2EsTUFBRixDQUFTLFNBQVQsQ0FBNUIsR0FBa0QsR0FBbEQsR0FBd0RDLElBQUksQ0FBQ0MsR0FBTCxFQUF6RCxDQUFWO0FBQ0g7O0FBRUQsSUFBTUMsa0JBQWtCLEdBQUcsU0FBckJBLGtCQUFxQixDQUFTQyxJQUFULEVBQWNDLEtBQWQsRUFBb0I7QUFDM0NBLEVBQUFBLEtBQUssQ0FBQ0MsVUFBTixHQUFtQkQsS0FBSyxDQUFDQyxVQUFOLElBQW9CLEVBQXZDO0FBQ0EsTUFBSUMsY0FBYyxHQUFHRixLQUFLLENBQUNDLFVBQU4sQ0FBaUJFLElBQXRDO0FBQ0EsTUFBRyxDQUFDRCxjQUFKLEVBQW1CO0FBQ2ZBLElBQUFBLGNBQWMsR0FBR1Isa0JBQWtCLEVBQW5DO0FBQ0g7QUFDRCxNQUFJVSxHQUFHLEdBQUdyQixHQUFHLENBQUVnQixJQUFJLEdBQUMsR0FBTCxHQUFTRyxjQUFYLENBQWI7QUFD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UFgsRUFPZ0I7QUFDbEMsYUFBT0MsTUFBTSxDQUFDRix3QkFBUCxDQUFnQ0osTUFBaEMsRUFBd0NLLElBQXhDLENBQVA7QUFDSCxLQVRxQjtBQVV0QkUsSUFBQUEsT0FWc0IsbUJBVWRQLE1BVmMsRUFVUDtBQUNYLGFBQU9NLE1BQU0sQ0FBQ0UsbUJBQVAsQ0FBMkJSLE1BQTNCLENBQVA7QUFDSCxLQVpxQjtBQWF0QlMsSUFBQUEsY0Fic0IsMEJBYVBULE1BYk8sRUFhQ0ssSUFiRCxFQWFPSyxrQkFiUCxFQWEwQjs7QUFFL0MsS0FmcUI7QUFnQnRCQyxJQUFBQSxjQWhCc0IsMEJBZ0JQWCxNQWhCTyxFQWdCQ0ssSUFoQkQsRUFnQk07O0FBRTNCLEtBbEJxQjtBQW1CdEJPLElBQUFBLGlCQW5Cc0IsNkJBbUJKWixNQW5CSSxFQW1CRzs7QUFFeEIsS0FyQnFCO0FBc0J0QjdCLElBQUFBLEdBdEJzQixlQXNCbEI2QixNQXRCa0IsRUFzQlZLLElBdEJVLEVBc0JMO0FBQ2IsYUFBT0EsSUFBSSxJQUFJTCxNQUFmO0FBQ0gsS0F4QnFCLEVBQW5CLENBQVA7O0FBMEJILEM7Ozs7QUFJR1IsUyxHQUFBQSxTLFNBQVV3QixTLEdBQUFBLFMsU0FBVXBELGtCLEdBQUFBLGtCLFNBQW1Cd0QsYSxHQUFBQSxhLFNBQWM1RCxrQixHQUFBQSxrQixTQUFtQjBFLFcsR0FBQUEsVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ3VuZGVyc2NvcmUnO1xuXG5pbXBvcnQgbWQ1IGZyb20gJ21kNSc7XG5pbXBvcnQgRUpTT04gZnJvbSAnZWpzb24nO1xuaW1wb3J0IHZtIGZyb20gJ3ZtJztcblxuY29uc3QgZXNwcmltYSA9IHJlcXVpcmUoJ2VzcHJpbWEnKTtcbmNvbnN0IGVzY29kZWdlbiA9IHJlcXVpcmUoJ2VzY29kZWdlbicpO1xuaW1wb3J0IE1hbGlidW5DYWNoZSBmcm9tIFwiLi9NYWxpYnVuQ2FjaGVcIjtcbmNvbnN0IGZiQ2FjaGUgPSBuZXcgTWFsaWJ1bkNhY2hlKCk7XG5jb25zdCBmdW5jdGlvbkdlbmVyYXRvciA9IG5ldyB2bS5TY3JpcHQoIGBuZXcgRnVuY3Rpb24oIHZtMk9wdGlvbnMuZnVuY3Rpb25Cb2R5ICk7YCApO1xuY29uc3Qgc2NyaXB0Q2FjaGUgPSBuZXcgTWFsaWJ1bkNhY2hlKCk7XG5cbmZ1bmN0aW9uIGdlbmVyYXRlUmFuZG9tSGFzaCgpIHtcbiAgICByZXR1cm4gbWQ1KF8ucmFuZG9tKDEwMDAwMDAwMCkgKyAnXycgKyBfLnJhbmRvbSgxMDAwMDAwMDApICsgJ18nICsgRGF0ZS5ub3coKSk7XG59XG5cbmNvbnN0IGZ1bmN0aW9uRnJvbVNjcmlwdCA9IGZ1bmN0aW9uKGV4cHIsdm1DdHgpe1xuICAgIHZtQ3R4LnZtMk9wdGlvbnMgPSB2bUN0eC52bTJPcHRpb25zIHx8IHt9O1xuICAgIGxldCB2bTJPcHRpb25zSGFzaCA9IHZtQ3R4LnZtMk9wdGlvbnMuaGFzaDtcbiAgICBpZighdm0yT3B0aW9uc0hhc2gpe1xuICAgICAgICB2bTJPcHRpb25zSGFzaCA9IGdlbmVyYXRlUmFuZG9tSGFzaCgpO1xuICAgIH1cbiAgICBsZXQga2V5ID0gbWQ1KCBleHByKyc6Jyt2bTJPcHRpb25zSGFzaCAgKTtcbiAgICBpZighZmJDYWNoZS5oYXMoa2V5KSkge1xuICAgICAgICBsZXQgdG9rZW5zID0gbnVsbDtcbiAgICAgICAgdHJ5e1xuICAgICAgICAgICAgdG9rZW5zID0gZXNwcmltYS5wYXJzZVNjcmlwdChleHByLHt0b2xlcmFudDp0cnVlfSk7XG4gICAgICAgIH1jYXRjaCAoZSkge1xuICAgICAgICAgICAgdG9rZW5zID0gZXNwcmltYS5wYXJzZVNjcmlwdChgKGZ1bmN0aW9uIGFub255bW91cygpeyAke2V4cHJ9IH0pLmFwcGx5KCB0aGlzICk7YCx7dG9sZXJhbnQ6dHJ1ZX0pXG4gICAgICAgIH1cbiAgICAgICAgbGV0IGxhc3RJbmRleCA9IDA7XG4gICAgICAgIF8uZWFjaCh0b2tlbnMuYm9keSwoc3RhdGVtZW50LGluZGV4KT0+e1xuICAgICAgICAgICAgaWYoIHN0YXRlbWVudC50eXBlIT0nRW1wdHlTdGF0ZW1lbnQnICl7XG4gICAgICAgICAgICAgICAgbGFzdEluZGV4PWluZGV4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgbGV0IGxhc3RFeHByZXNzaW9uID0gdG9rZW5zLmJvZHlbbGFzdEluZGV4XTtcbiAgICAgICAgaWYobGFzdEV4cHJlc3Npb24pIHtcbiAgICAgICAgICAgIGlmKFsnSWZTdGF0ZW1lbnQnLCdSZXR1cm5TdGF0ZW1lbnQnXS5pbmRleE9mKGxhc3RFeHByZXNzaW9uLnR5cGUpID09IC0xICl7XG4gICAgICAgICAgICAgICAgdG9rZW5zLmJvZHlbdG9rZW5zLmJvZHkubGVuZ3RoIC0gMV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdSZXR1cm5TdGF0ZW1lbnQnLFxuICAgICAgICAgICAgICAgICAgICBhcmd1bWVudDogbGFzdEV4cHJlc3Npb24sXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBmdW5jdGlvbkJvZHkgPSBlc2NvZGVnZW4uZ2VuZXJhdGUodG9rZW5zKTtcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coZnVuY3Rpb25Cb2R5KTtcblxuXG4gICAgICAgICAgICB2bUN0eC52bTJPcHRpb25zLmZ1bmN0aW9uQm9keSA9IGZ1bmN0aW9uQm9keTtcbiAgICAgICAgICAgIGxldCBmID0gZnVuY3Rpb25HZW5lcmF0b3IucnVuSW5Db250ZXh0KHZtQ3R4KTtcblxuICAgICAgICAgICAgLy92YXIgZiA9IG5ldyBGdW5jdGlvbihmdW5jdGlvbkJvZHkpO1xuICAgICAgICAgICAgZmJDYWNoZS5zZXQoa2V5LCBmLCA1ICogNjAgKiAxMDAwKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmJDYWNoZS5nZXQoa2V5KTtcbn07XG5cblxuLyoqXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBzY29wZVxuICogQHJldHVybnMge09iamVjdH0gc2NvcGUudm1cbiAqIEByZXR1cm5zIHtPYmplY3R9IHNjb3BlLm9yaWdpbmFsXG4gKiBAcGFyYW0ge1ZNUnVubmVyfSBydW5uZXJcbiAqICovXG5mdW5jdGlvbiB3cmFwU2NvcGUoc2NvcGUscnVubmVyLHZtMk9wdGlvbnMpe1xuICAgIGxldCBzY29wZUNvcHkgPSB7fTsvL09iamVjdC5hc3NpZ24oe30sc2NvcGUpO1xuXG4gICAgXy5lYWNoKHNjb3BlLChpbnN0YW5jZSxrZXkpPT57XG4gICAgICAgIGxldCB3cmFwcGVkID0gbnVsbDtcbiAgICAgICAgaWYoXy5pc09iamVjdChpbnN0YW5jZSkgKXtcbiAgICAgICAgICAgIHdyYXBwZWQgPSBuZXcgUHJveHkoaW5zdGFuY2Use1xuICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24odGFyZ2V0LCBwcm9wZXJ0eSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BlcnR5XTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnc2V0IGtleTonLGtleSwndmFsdWU6Jyx2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG93bktleXModGFyZ2V0KXtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRhcmdldCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIG5hbWUsIHByb3BlcnR5RGVzY3JpcHRvcil7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwgbmFtZSl7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHByZXZlbnRFeHRlbnNpb25zKHRhcmdldCl7XG5cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGhhcyh0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmFtZSBpbiB0YXJnZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1lbHNle1xuICAgICAgICAgICAgd3JhcHBlZCA9IGluc3RhbmNlO1xuICAgICAgICB9XG4gICAgICAgIHNjb3BlQ29weVtrZXldID0gd3JhcHBlZDtcbiAgICB9KTtcblxuICAgIHNjb3BlQ29weS52bTJPcHRpb25zID0gdm0yT3B0aW9ucztcblxuICAgIGxldCB2bUNvbnRleHQgPSB2bS5jcmVhdGVDb250ZXh0KCBzY29wZUNvcHkgKTtcbiAgICByZXR1cm4ge1xuICAgICAgICB2bTp2bUNvbnRleHQsXG4gICAgICAgIG9yaWdpbmFsOnNjb3BlQ29weVxuICAgIH1cbn1cblxuZnVuY3Rpb24gZ2V0U2NyaXB0KGNvZGUpe1xuICAgIGlmKCFfLmlzU3RyaW5nKGNvZGUpfHwhY29kZSl7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBpZighc2NyaXB0Q2FjaGUuaGFzKGNvZGUpKXtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHNjcmlwdCA9IG5ldyB2bS5TY3JpcHQoY29kZSk7XG4gICAgICAgICAgICBzY3JpcHRDYWNoZS5zZXQoY29kZSwgc2NyaXB0LCA1ICogNjAgKiAxMDAwKTtcbiAgICAgICAgfWNhdGNoKGUpe1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHNjcmlwdENhY2hlLmdldChjb2RlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29udmVydFJlc3VsdChyZXN1bHQpe1xuICAgIGxldCBjb252ZXJ0ZWQgPSByZXN1bHQ7XG4gICAgaWYoXy5pc0RhdGUocmVzdWx0KSl7XG4gICAgICAgIGNvbnZlcnRlZCA9IG5ldyBEYXRlKCByZXN1bHQuZ2V0VGltZSgpICk7XG4gICAgfWVsc2UgaWYocmVzdWx0ICYmIF8uaXNGdW5jdGlvbihyZXN1bHQudGhlbikpe1xuICAgICAgICBjb252ZXJ0ZWQgPSBhd2FpdCByZXN1bHQ7XG4gICAgfWVsc2UgaWYocmVzdWx0JiZ0eXBlb2YgcmVzdWx0PT0nb2JqZWN0Jyl7XG4gICAgICAgIGNvbnZlcnRlZCA9IEVKU09OLmNsb25lKHJlc3VsdCk7XG4gICAgICAgIGZ1bmN0aW9uIGNoZWNrKHRhcmdldCxzb3VyY2Usa2V5KXtcbiAgICAgICAgICAgIGxldCB2YWwgPSBzb3VyY2Vba2V5XTtcbiAgICAgICAgICAgIGlmKHR5cGVvZiB2YWw9PSdmdW5jdGlvbicpe1xuICAgICAgICAgICAgICAgIHRhcmdldFtrZXldPXZhbDtcbiAgICAgICAgICAgIH1lbHNlIGlmKF8uaXNEYXRlKHZhbCkpe1xuICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gbmV3IERhdGUoIHZhbCApO1xuICAgICAgICAgICAgfWVsc2UgaWYoXy5pc0FycmF5KHZhbCl8fF8uaXNPYmplY3QodmFsKSl7XG4gICAgICAgICAgICAgICAgXy5lYWNoKF8ua2V5cyh2YWwpLCh2YWxLZXkpPT57XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrKCB0YXJnZXRba2V5XSAsIHZhbCwgdmFsS2V5KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBfLmVhY2goXy5rZXlzKHJlc3VsdCksKGtleSk9PntcbiAgICAgICAgICAgIGNoZWNrKGNvbnZlcnRlZCxyZXN1bHQsa2V5KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjb252ZXJ0ZWQ7XG59XG5cbmZ1bmN0aW9uIHdyYXBJblByb3h5KGluc3RhbmNlKXtcbiAgICByZXR1cm4gbmV3IFByb3h5KGluc3RhbmNlLHtcbiAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5KSB7XG4gICAgICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BlcnR5XTtcbiAgICAgICAgfSxcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcikge1xuXG4gICAgICAgIH0sXG4gICAgICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpe1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgICAgfSxcbiAgICAgICAgb3duS2V5cyh0YXJnZXQpe1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRhcmdldCk7XG4gICAgICAgIH0sXG4gICAgICAgIGRlZmluZVByb3BlcnR5KHRhcmdldCwgbmFtZSwgcHJvcGVydHlEZXNjcmlwdG9yKXtcblxuICAgICAgICB9LFxuICAgICAgICBkZWxldGVQcm9wZXJ0eSh0YXJnZXQsIG5hbWUpe1xuXG4gICAgICAgIH0sXG4gICAgICAgIHByZXZlbnRFeHRlbnNpb25zKHRhcmdldCl7XG5cbiAgICAgICAgfSxcbiAgICAgICAgaGFzKHRhcmdldCwgbmFtZSl7XG4gICAgICAgICAgICByZXR1cm4gbmFtZSBpbiB0YXJnZXQ7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuXG5leHBvcnQge1xuICAgIHdyYXBTY29wZSxnZXRTY3JpcHQsZnVuY3Rpb25Gcm9tU2NyaXB0LGNvbnZlcnRSZXN1bHQsZ2VuZXJhdGVSYW5kb21IYXNoLHdyYXBJblByb3h5XG59XG5cbiJdfQ==